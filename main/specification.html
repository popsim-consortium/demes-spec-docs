
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Specification &#8212; Demes Specification</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!-- 
    this give us a css class that will be invisible only if js is disabled 
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=145bf5bd" />
  
  <!-- So that users can add custom icons -->
  <script src="_static/scripts/fontawesome.js?digest=26a4bc78f4c0ddb94549"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549" />

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'specification';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Gallery" href="gallery.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="introduction.html">
  
  
  
  
  
  
    <p class="title logo__title">Demes Specification</p>
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="introduction.html">
                    Introduction
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="gallery.html">Gallery</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Specification</a></li>
<li class="toctree-l1"><a class="reference external" href="https://popsim-consortium.github.io/demes-docs/latest/CITATION.html">Citing Demes</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/popsim-consortium/demes-spec" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/popsim-consortium/demes-spec/edit/main/docs/specification.md" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/popsim-consortium/demes-spec/issues/new?title=Issue%20on%20page%20%2Fspecification.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/specification.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Specification</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#note-to-readers">Note to Readers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conventions-and-terminology">Conventions and Terminology</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#infinity">Infinity</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#machine-data-model">Machine Data Model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#common-concepts">Common concepts</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#time">Time</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#population-sizes">Population sizes</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#metadata">Metadata</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mdm-documents">MDM documents</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#description">description</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#doi">doi</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">metadata</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#time-units">time_units</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#generation-time">generation_time</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#demes">demes</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#pulses">pulses</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#migrations">migrations</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#deme">Deme</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#name">name</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">description</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ancestors">ancestors</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#proportions">proportions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#start-time">start_time</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#epochs">epochs</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#epoch">Epoch</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#end-time">end_time</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#start-size">start_size</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#end-size">end_size</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#size-function">size_function</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cloning-rate">cloning_rate</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#selfing-rate">selfing_rate</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pulse">Pulse</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sources">sources</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dest">dest</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">time</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">proportions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-sequential-application-of-pulses">Example: sequential application of pulses</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#important-considerations">Important considerations</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#migration">Migration</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#source">source</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">dest</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">start_time</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">end_time</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#rate">rate</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#schema">Schema</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#human-data-model">Human Data Model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#defaults">Defaults</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#top-level-defaults">Top-level defaults</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#deme-defaults">Deme defaults</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#resolution">Resolution</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-time-units">time_units</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-generation-time">generation_time</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-metadata">metadata</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-description">description</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-doi">doi</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-defaults">defaults</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#deme-resolution">Deme resolution</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-deme-defaults">defaults</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-deme-description">description</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-deme-ancestors">ancestors</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-deme-proportions">proportions</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-deme-start-time">start_time</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#epoch-resolution">Epoch resolution</a><ul class="nav section-nav flex-column">
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-epoch-end-time">end_time</a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#start-size-end-size">start_size, end_size</a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-epoch-size-function">size_function</a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-epoch-selfing-rate">selfing_rate</a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-epoch-cloning-rate">cloning_rate</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#migration-resolution">Migration resolution</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-migration-rate">rate</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-migration-source">source</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-migration-dest">dest</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-migration-demes">demes</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#symmetric-migration">Symmetric migration</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-migration-start-time">start_time</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-migration-end-time">end_time</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#pulse-resolution">Pulse resolution</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-pulse-sources">sources</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-pulse-proportions">proportions</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-pulse-dest">dest</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-pulse-time">time</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sort-pulses">Sort pulses</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#validation">Validation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id37">generation_time</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id38">demes</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#id39">epochs</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id40">migrations</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id41">pulses</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-schema">Schema</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reference-parser-implementation">Reference parser implementation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#appendix">Appendix</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#converting-backwards-time-to-forwards-time">Converting backwards time to forwards time</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="specification">
<span id="sec-spec"></span><h1>Specification<a class="headerlink" href="#specification" title="Link to this heading">#</a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>Demes is a specification for describing population genetic models
of demographic history. This specification precisely defines the
population genetics model and its assumptions, along with
the data model used for interchange and the required behaviour
of implementations.</p>
<p>The Demes standard is largely agnostic to the processes that occur
within populations, and provides a minimal set of parameters that
can accommodate a wide spectrum of population genetic models.</p>
<div class="admonition-who-is-this-specification-for admonition">
<p class="admonition-title">Who is this specification for?</p>
<p>This specification is intended to provide a detailed and definitive resource
for the following groups:</p>
<ul class="simple">
<li><p>Those implementing support for Demes as an input or output format in their programs</p></li>
<li><p>Those implementing a Demes parser</p></li>
</ul>
<p>As such, this specification contains a lot of detail that is not
interesting to most users.
If you wish to learn how to understand and create your own
Demes models, please see the <a class="reference internal" href="tutorial.html#sec-tutorial"><span class="std std-ref">Tutorial</span></a> instead.</p>
</div>
</section>
<section id="note-to-readers">
<h2>Note to Readers<a class="headerlink" href="#note-to-readers" title="Link to this heading">#</a></h2>
<p>To provide feedback on this specification, please use the
<a class="reference external" href="https://github.com/popsim-consortium/demes-spec/issues">issue tracker</a>.</p>
</section>
<section id="conventions-and-terminology">
<span id="sec-spec-terminology"></span><h2>Conventions and Terminology<a class="headerlink" href="#conventions-and-terminology" title="Link to this heading">#</a></h2>
<p>The term “Demes” in this document is to be interpreted as a
reference to this specification. A <a class="reference internal" href="#sec-spec-mdm-deme"><span class="std std-ref">deme</span></a>
refers to a set of individuals that can be modelled by a fixed
set of parameters; to avoid confusion with name of the specification
we will usually use the term “population”, in the understanding that
the terms are equivalent for the purposes of this document.</p>
<div class="admonition-todo admonition" id="id1">
<p class="admonition-title">Todo</p>
<p>Define the human and machine data models. And link to assumptions.</p>
</div>
<p>The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”,
“SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL” in this document are to be
interpreted as described in <a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc2119">RFC 2119</a>.</p>
<p>The terms “JSON”, “JSON text”, “JSON value”, “member”, “element”, “object”,
“array”, “number”, “string”, “boolean”, “true”, “false”, and “null” in this
document are to be interpreted as defined in
<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc8259">RFC 8259</a>.</p>
<p>The term “JSON Schema” in this document is to be interpreted as defined
in the JSON Schema
<a class="reference external" href="https://json-schema.org/draft/2020-12/json-schema-core.html">core specification</a>.</p>
<section id="infinity">
<span id="sec-spec-infinity"></span><h3>Infinity<a class="headerlink" href="#infinity" title="Link to this heading">#</a></h3>
<p>JSON does not define an encoding for infinite-valued numbers.
However, infinite values are used in Demes for start times.
When <strong>writing</strong> a Demes model to a format that does not permit infinity,
such as JSON, the string “Infinity” must be used to encode infinity.
When writing to formats that do support infinity, such as YAML, the native
encoding for infinity should be used instead (<code class="docutils literal notranslate"><span class="pre">.inf</span></code> in YAML).
When <strong>reading</strong> a Demes model, the string “Infinity” must be decoded to mean
an infinite-valued number. When reading from formats that do support infinity,
the format’s native encoding for infinite-valued numbers must also be
supported.</p>
</section>
</section>
<section id="machine-data-model">
<span id="sec-spec-mdm"></span><h2>Machine Data Model<a class="headerlink" href="#machine-data-model" title="Link to this heading">#</a></h2>
<p>The Demes Machine Data Model (MDM) is a
formal representation of the Demes model as
a JSON document.
The MDM is designed to be
used as input by programs such as population genetics simulators,
and explicitly includes all necessary details.
The structure of JSON
documents conforming to the specification is formally defined
in the <a class="reference internal" href="#sec-spec-mdm-schema"><span class="std std-ref">Schema</span></a>, and the detailed requirements for each of the
elements in this data model are defined in this section.</p>
<p>The Demes <a class="reference internal" href="#sec-spec-hdm"><span class="std std-ref">Human Data Model</span></a> (HDM)
is a closely related specification that is intended
to be easily human-readable and writable.
An MDM document is also a valid HDM document.
An MDM document is constructed by <a class="reference internal" href="#sec-spec-hdm-resolution"><span class="std std-ref">resolving</span></a>
and <a class="reference internal" href="#sec-spec-hdm-validation"><span class="std std-ref">validating</span></a> an HDM document.</p>
<section id="common-concepts">
<span id="sec-spec-defs-common"></span><h3>Common concepts<a class="headerlink" href="#common-concepts" title="Link to this heading">#</a></h3>
<p>This section provides details on properties that occur in multiple
contexts.</p>
<section id="time">
<span id="sec-spec-mdm-time"></span><h4>Time<a class="headerlink" href="#time" title="Link to this heading">#</a></h4>
<p>Times are specified as units in the past, so that time zero
corresponds to the final generation or “now”, and event times in the past are
values greater than zero with larger values for events that occur in the more
distant past.
By default, time is measured in generations, but other values (“years”,
for example) are allowed.
When time units
are not given in generations, the generation time must also be specified so
that times can be converted into generations. In general, as time flows from
the past to the present, populations, epochs, and migration events should be
specified in their order of appearance, so that their times are in descending
order.</p>
</section>
<section id="population-sizes">
<span id="sec-spec-mdm-population-sizes"></span><h4>Population sizes<a class="headerlink" href="#population-sizes" title="Link to this heading">#</a></h4>
<p>A fundamental concept in demes is the population size.</p>
<div class="admonition-todo admonition" id="id2">
<p class="admonition-title">Todo</p>
<p>Things to cover:</p>
<ul class="simple">
<li><p>We’re counting <strong>individuals</strong> not genomes</p></li>
<li><p>We usually mean the population size in expectation, but there’s
no hard requirements. For example, it’s up the implementation whether it thinks
a population size of 0.33 is meaningful. Clarify with
some examples from forward and backward sims.</p></li>
<li><p>What do proportions mean? Similar point to pop size above. Give forward
pointers to sections we mention proportions in.</p></li>
<li><p>What do we mean by migration of individuals? Forward pointers to sections.</p></li>
</ul>
</div>
</section>
<section id="metadata">
<span id="sec-spec-mdm-metadata"></span><h4>Metadata<a class="headerlink" href="#metadata" title="Link to this heading">#</a></h4>
<div class="admonition-todo admonition" id="id3">
<p class="admonition-title">Todo</p>
<p>Discussion of metadata. What’s it for?</p>
</div>
</section>
</section>
<section id="mdm-documents">
<h3>MDM documents<a class="headerlink" href="#mdm-documents" title="Link to this heading">#</a></h3>
<p>The top-level MDM document describes a single instance of a Demes model.</p>
<p>Each MDM document contains the following list of properties. All
properties MUST be specified, and additional properties MUST NOT be
included in these documents. Please see the <a class="reference internal" href="#sec-spec-mdm-schema"><span class="std std-ref">Schema</span></a>
for definitive details on the types and structure of these properties.</p>
<section id="description">
<h4>description<a class="headerlink" href="#description" title="Link to this heading">#</a></h4>
<p>A concise description of the demographic model.</p>
</section>
<section id="doi">
<h4>doi<a class="headerlink" href="#doi" title="Link to this heading">#</a></h4>
<p>The DOI(s) of the publication(s) in which the model was inferred or
originally described.</p>
</section>
<section id="id4">
<h4>metadata<a class="headerlink" href="#id4" title="Link to this heading">#</a></h4>
<p>An object containing arbitrary additional properties and values.
May be empty.</p>
</section>
<section id="time-units">
<span id="sec-spec-mdm-time-units"></span><h4>time_units<a class="headerlink" href="#time-units" title="Link to this heading">#</a></h4>
<p>The units of time used to specify times and time intervals. These
SHOULD be one of “generations” or “years”.</p>
</section>
<section id="generation-time">
<h4>generation_time<a class="headerlink" href="#generation-time" title="Link to this heading">#</a></h4>
<p>The number by which times must be divided, to convert them to have
units of generations.
Hence <code class="docutils literal notranslate"><span class="pre">generation_time</span></code> uses the same time units specified by <code class="docutils literal notranslate"><span class="pre">time_units</span></code>.</p>
</section>
<section id="demes">
<h4>demes<a class="headerlink" href="#demes" title="Link to this heading">#</a></h4>
<p>The list of <a class="reference internal" href="#sec-spec-mdm-deme"><span class="std std-ref">demes</span></a> in the model.
At least one deme MUST be specified.</p>
</section>
<section id="pulses">
<h4>pulses<a class="headerlink" href="#pulses" title="Link to this heading">#</a></h4>
<p>The list of <a class="reference internal" href="#sec-spec-mdm-pulse"><span class="std std-ref">pulses</span></a> in the model.</p>
</section>
<section id="migrations">
<h4>migrations<a class="headerlink" href="#migrations" title="Link to this heading">#</a></h4>
<p>The list of <a class="reference internal" href="#sec-spec-mdm-migration"><span class="std std-ref">migrations</span></a> in the model.</p>
</section>
</section>
<section id="deme">
<span id="sec-spec-mdm-deme"></span><h3>Deme<a class="headerlink" href="#deme" title="Link to this heading">#</a></h3>
<p>A Deme is a single population (see the <a class="reference internal" href="#sec-spec-terminology"><span class="std std-ref">Conventions and Terminology</span></a> for
clarification of these two terms) that exists for some non-empty
time interval. A population is defined operationally as some set
of individuals that can be modelled by a set of fixed parameters
over a series of <a class="reference internal" href="#sec-spec-mdm-epoch"><span class="std std-ref">epochs</span></a>.
Population parameters are defined per epoch, and are defined in the
<a class="reference internal" href="#sec-spec-mdm-epoch"><span class="std std-ref">Epoch</span></a> section below.</p>
<p>A population may have one
or more ancestors, which are other populations that exist at the population’s
start time. If one ancestor is specified, the first generation is constructed
by randomly sampling parents from the ancestral population to contribute to
offspring in the newly generated population.</p>
<p>If more than one ancestor is
specified, the proportions of ancestry from each contributing population must
be provided, and those proportions must sum to one. In this case, parents are
chosen randomly from each ancestral population with probability given by those
proportions. If no ancestors are specified, the population is assumed to have
start time equal to infinity.</p>
<p>The deme may be a descendant of one or more demes in the graph, and may
be an ancestor to others. The deme exists over the half-open time interval
<code class="docutils literal notranslate"><span class="pre">(start_time,</span> <span class="pre">end_time]</span></code>, and it may continue to exist after
contributing ancestry to a descendant deme. The deme’s <code class="docutils literal notranslate"><span class="pre">end_time</span></code> is
implicit (there is no <code class="docutils literal notranslate"><span class="pre">end_time</span></code> deme property), but for convenience we
define it as the <code class="docutils literal notranslate"><span class="pre">end_time</span></code> of the deme’s last epoch.</p>
<section id="name">
<h4>name<a class="headerlink" href="#name" title="Link to this heading">#</a></h4>
<p>A string identifier for a deme, which MUST be unique among all demes in a document.
Must be a valid
<a class="reference external" href="https://docs.python.org/3/reference/lexical_analysis.html#identifiers">python identifier</a></p>
</section>
<section id="id5">
<h4>description<a class="headerlink" href="#id5" title="Link to this heading">#</a></h4>
<p>A concise description of the deme.</p>
</section>
<section id="ancestors">
<span id="sec-spec-mdm-deme-ancestors"></span><h4>ancestors<a class="headerlink" href="#ancestors" title="Link to this heading">#</a></h4>
<p>The list of ancestors of the deme at the start of the deme’s first epoch.
May be an empty list if the deme has no ancestors in the graph,
in which case the <code class="docutils literal notranslate"><span class="pre">start_time</span></code> must be infinite.
Each ancestor must be in the graph, and each ancestor must be
specified only once. A deme must not be one of its own ancestors.</p>
</section>
<section id="proportions">
<span id="sec-spec-mdm-deme-proportions"></span><h4>proportions<a class="headerlink" href="#proportions" title="Link to this heading">#</a></h4>
<p>The proportions of ancestry derived from each of the <code class="docutils literal notranslate"><span class="pre">ancestors</span></code>
at the start of the deme’s first epoch.
The <code class="docutils literal notranslate"><span class="pre">proportions</span></code> must be ordered to correspond with the
order of <code class="docutils literal notranslate"><span class="pre">ancestors</span></code>. The proportions must be an empty list or sum to 1
(within a reasonable tolerance, e.g. 1e-9). See the
<a class="reference internal" href="#sec-spec-mdm-population-sizes"><span class="std std-ref">Population sizes</span></a> section for more details on
how these proportions should be interpreted.</p>
</section>
<section id="start-time">
<span id="sec-spec-mdm-deme-start-time"></span><h4>start_time<a class="headerlink" href="#start-time" title="Link to this heading">#</a></h4>
<p>The most ancient <a class="reference internal" href="#sec-spec-mdm-time"><span class="std std-ref">time</span></a>
at which the deme exists, in <a class="reference internal" href="#sec-spec-mdm-time-units"><span class="std std-ref">time_units</span></a>
before the present. Demes with no ancestors are root demes and must
have an infinite <code class="docutils literal notranslate"><span class="pre">start_time</span></code>. Otherwise, the <code class="docutils literal notranslate"><span class="pre">start_time</span></code> must
correspond with the interval of existence
for each of the deme’s <code class="docutils literal notranslate"><span class="pre">ancestors</span></code>. I.e. the <code class="docutils literal notranslate"><span class="pre">start_time</span></code> must
be within the half-open interval <code class="docutils literal notranslate"><span class="pre">(deme.start_time,</span> <span class="pre">deme.end_time]</span></code>
for each deme in <code class="docutils literal notranslate"><span class="pre">ancestors</span></code>.</p>
</section>
<section id="epochs">
<h4>epochs<a class="headerlink" href="#epochs" title="Link to this heading">#</a></h4>
<p>The list of <a class="reference internal" href="#sec-spec-mdm-epoch"><span class="std std-ref">epochs</span></a> for this deme.
There MUST be at least one epoch for each deme.</p>
</section>
</section>
<section id="epoch">
<span id="sec-spec-mdm-epoch"></span><h3>Epoch<a class="headerlink" href="#epoch" title="Link to this heading">#</a></h3>
<p>A deme-specific period of time spanning the half-open interval
<code class="docutils literal notranslate"><span class="pre">(start_time,</span> <span class="pre">end_time]</span></code>, in which a fixed set of population parameters
apply. The epoch’s <code class="docutils literal notranslate"><span class="pre">start_time</span></code> is implicit (there is no <code class="docutils literal notranslate"><span class="pre">start_time</span></code>
epoch property), but for convenience we define it as the <code class="docutils literal notranslate"><span class="pre">end_time</span></code> of the
previous epoch, or the deme’s <code class="docutils literal notranslate"><span class="pre">start_time</span></code> if it is the first epoch.</p>
<p>Each epoch specifies the <a class="reference internal" href="#sec-spec-mdm-population-sizes"><span class="std std-ref">population size</span></a>
over that interval, which can be a constant value or function defined by start
and end sizes that must remain positive.  If an epoch has a start time of
infinity, the population size for that epoch must be constant.</p>
<p>Epochs can also
specify parameters for nonrandom mating, such as selfing or cloning rates,
which give the probability that offspring are generated from one generation to
the next by self-fertilisation or cloning of an individual. Selfing and cloning
rates take values between zero and one.</p>
<section id="end-time">
<h4>end_time<a class="headerlink" href="#end-time" title="Link to this heading">#</a></h4>
<p>The most recent <a class="reference internal" href="#sec-spec-mdm-time"><span class="std std-ref">time</span></a> of the epoch,
in <a class="reference internal" href="#sec-spec-mdm-time-units"><span class="std std-ref">time_units</span></a> before the present.</p>
</section>
<section id="start-size">
<h4>start_size<a class="headerlink" href="#start-size" title="Link to this heading">#</a></h4>
<p>The population size at the epoch’s <code class="docutils literal notranslate"><span class="pre">start_time</span></code>.</p>
</section>
<section id="end-size">
<h4>end_size<a class="headerlink" href="#end-size" title="Link to this heading">#</a></h4>
<p>The population size at the epoch’s <code class="docutils literal notranslate"><span class="pre">end_time</span></code>.</p>
</section>
<section id="size-function">
<h4>size_function<a class="headerlink" href="#size-function" title="Link to this heading">#</a></h4>
<p>A function describing the population size change between
<code class="docutils literal notranslate"><span class="pre">start_time</span></code> and <code class="docutils literal notranslate"><span class="pre">end_time</span></code>.
This may be any string, but the values “constant” and “exponential”
are explicitly acknowledged to have the following meanings.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">constant</span></code>: the deme’s size does not change over the epoch.
<code class="docutils literal notranslate"><span class="pre">start_size</span></code> and <code class="docutils literal notranslate"><span class="pre">end_size</span></code> must be equal.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">exponential</span></code>: the deme’s size changes exponentially from
<code class="docutils literal notranslate"><span class="pre">start_size</span></code> to <code class="docutils literal notranslate"><span class="pre">end_size</span></code> over the epoch.
If <code class="docutils literal notranslate"><span class="pre">t</span></code> is a time within the span of the epoch,
the deme size <code class="docutils literal notranslate"><span class="pre">N</span></code> at time <code class="docutils literal notranslate"><span class="pre">t</span></code> can be calculated as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">epoch</span><span class="o">.</span><span class="n">start_time</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">epoch</span><span class="o">.</span><span class="n">start_time</span> <span class="o">-</span> <span class="n">epoch</span><span class="o">.</span><span class="n">end_time</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">log</span><span class="p">(</span><span class="n">epoch</span><span class="o">.</span><span class="n">end_size</span> <span class="o">/</span> <span class="n">epoch</span><span class="o">.</span><span class="n">start_size</span><span class="p">)</span>
<span class="n">N</span> <span class="o">=</span> <span class="n">epoch</span><span class="o">.</span><span class="n">start_size</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">size_function</span></code> must be <code class="docutils literal notranslate"><span class="pre">constant</span></code> if the epoch has an infinite <code class="docutils literal notranslate"><span class="pre">start_time</span></code>.</p>
</section>
<section id="cloning-rate">
<h4>cloning_rate<a class="headerlink" href="#cloning-rate" title="Link to this heading">#</a></h4>
<p>The proportion of offspring in each generation that
are expected to be generated through clonal reproduction.
<code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">-</span> <span class="pre">cloning_rate</span></code> are expected to arise through sexual reproduction.</p>
</section>
<section id="selfing-rate">
<h4>selfing_rate<a class="headerlink" href="#selfing-rate" title="Link to this heading">#</a></h4>
<p>Within the sexually-reproduced offspring,
<code class="docutils literal notranslate"><span class="pre">selfing_rate</span></code> are born via self-fertilisation while the rest
have parents drawn at random from the previous generation.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Depending on the simulator, this random drawing of parent may occur
either with or without replacement. When drawing occurs with replacement, a small
amount of residual selfing is expected, so that even with <code class="docutils literal notranslate"><span class="pre">cloning_rate=0</span></code>
and <code class="docutils literal notranslate"><span class="pre">selfing_rate=0</span></code>, selfing may still occur with probability <code class="docutils literal notranslate"><span class="pre">1/N</span></code>.
Simulators that allow variable rates of selfing are expected to clearly
document their behaviour.</p>
</div>
</section>
</section>
<section id="pulse">
<span id="sec-spec-mdm-pulse"></span><h3>Pulse<a class="headerlink" href="#pulse" title="Link to this heading">#</a></h3>
<p>An instantaneous pulse of migration at <code class="docutils literal notranslate"><span class="pre">time</span></code>, from a list of source demes
(<code class="docutils literal notranslate"><span class="pre">sources</span></code>) into the destination deme (<code class="docutils literal notranslate"><span class="pre">dest</span></code>).</p>
<p>Pulse
migration events specify the instantaneous replacement of a given fraction of
individuals in a destination population by individuals with parents from
a source population.  The fraction must be between zero and one, and if more
than one pulse occurs at the same time, those replacement events are applied
sequentially in the order that they are specified in the model.
The list of pulses must be sorted in time-descending order.</p>
<section id="sources">
<h4>sources<a class="headerlink" href="#sources" title="Link to this heading">#</a></h4>
<p>The list of deme names of the migration sources.</p>
</section>
<section id="dest">
<h4>dest<a class="headerlink" href="#dest" title="Link to this heading">#</a></h4>
<p>The deme name of the migration destination.</p>
</section>
<section id="id6">
<h4>time<a class="headerlink" href="#id6" title="Link to this heading">#</a></h4>
<p>The time of migration, in
in <a class="reference internal" href="#sec-spec-mdm-time-units"><span class="std std-ref">time_units</span></a> before the present.
The demes defined by <code class="docutils literal notranslate"><span class="pre">sources</span></code> and <code class="docutils literal notranslate"><span class="pre">dest</span></code> must both exist at the given
<code class="docutils literal notranslate"><span class="pre">time</span></code>.  I.e. <code class="docutils literal notranslate"><span class="pre">time</span></code> must be contained in the
<code class="docutils literal notranslate"><span class="pre">(deme.start_time,</span> <span class="pre">deme.end_time]</span></code> interval of the <code class="docutils literal notranslate"><span class="pre">sources</span></code>
demes and the <code class="docutils literal notranslate"><span class="pre">dest</span></code> deme.</p>
</section>
<section id="id7">
<h4>proportions<a class="headerlink" href="#id7" title="Link to this heading">#</a></h4>
<p>The proportions of ancestry in the <code class="docutils literal notranslate"><span class="pre">dest</span></code> deme derived from the demes
in <code class="docutils literal notranslate"><span class="pre">sources</span></code> immediately after the <code class="docutils literal notranslate"><span class="pre">time</span></code> of migration.
The <code class="docutils literal notranslate"><span class="pre">proportions</span></code> must be ordered to correspond with the order of
<code class="docutils literal notranslate"><span class="pre">sources</span></code>. The proportions must sum to less than or equal to 1
(within a reasonable tolerance, e.g. 1e-9).
See the
<a class="reference internal" href="#sec-spec-mdm-population-sizes"><span class="std std-ref">Population sizes</span></a> section for more details on
how proportions should be interpreted.</p>
</section>
<section id="example-sequential-application-of-pulses">
<h4>Example: sequential application of pulses<a class="headerlink" href="#example-sequential-application-of-pulses" title="Link to this heading">#</a></h4>
<p>Consider the following model:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">time_units</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">generations</span>
<span class="nt">demes</span><span class="p">:</span>
<span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">A</span>
<span class="w">   </span><span class="nt">epochs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">start_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>
<span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">B</span>
<span class="w">   </span><span class="nt">epochs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">start_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>
<span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">C</span>
<span class="w">   </span><span class="nt">epochs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">start_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>
<span class="nt">pulses</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">sources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">A</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">C</span>
<span class="w">  </span><span class="nt">proportions</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.25</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">time</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">sources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">B</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">C</span>
<span class="w">  </span><span class="nt">proportions</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.2</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">time</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</pre></div>
</div>
<p>Ten (10) generations ago, pulse events occur from source demes <code class="docutils literal notranslate"><span class="pre">A</span></code> and <code class="docutils literal notranslate"><span class="pre">B</span></code>
into destination deme <code class="docutils literal notranslate"><span class="pre">C</span></code>.</p>
<p>We need to arrive at the final ancestry proportions for destination deme <code class="docutils literal notranslate"><span class="pre">C</span></code> after this time.
Software implementing pulse events must generate output that is equivalent to the following
procedure.</p>
<p>The steps are:</p>
<ol class="arabic simple">
<li><p>Initialize an array of zeros with length equal to the number of demes.</p></li>
<li><p>Set the ancestry proportion of the destination deme to 1.</p></li>
<li><p>For each pulse:
a. Multiply the array by one (1) minus the sum of proportions.
b. For each source, add its proportion to the array.</p></li>
</ol>
<p>For the above model, the steps are:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">1.</span> <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="mf">2.</span> <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="mf">3.</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">0.25</span>
   <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">]</span>
   <span class="n">x</span><span class="p">[</span><span class="n">A</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">]</span>
   <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">0.2</span>
   <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">]</span>
   <span class="n">x</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">]</span>
</pre></div>
</div>
<p>Thus, our final ancestry proportions for deme <code class="docutils literal notranslate"><span class="pre">C</span></code> after time 10 are <code class="docutils literal notranslate"><span class="pre">[0.2,</span> <span class="pre">0.2,</span> <span class="pre">0.6]</span></code>.</p>
</section>
<section id="important-considerations">
<h4>Important considerations<a class="headerlink" href="#important-considerations" title="Link to this heading">#</a></h4>
<ul>
<li><p>The final ancestry proportions depend on the order of the pulses in the model!
If we reverse the above model such that:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">pulses</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">sources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">B</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">C</span>
<span class="w">  </span><span class="nt">proportions</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.2</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">time</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">sources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">A</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">C</span>
<span class="w">  </span><span class="nt">proportions</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.25</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">time</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</pre></div>
</div>
<p>We get <code class="docutils literal notranslate"><span class="pre">[0.25,</span> <span class="pre">0.15,</span> <span class="pre">0.6]</span></code> as our ancestry proportions due to pulses.</p>
<p>The fact that the outcome of applying sequential pulses depends on
the order is why <code class="docutils literal notranslate"><span class="pre">demes-python</span></code> emits a warning when resolving such models.</p>
</li>
<li><p>Given the procedure used to apply sequential pulses at the same time,
the followng two sets of <code class="docutils literal notranslate"><span class="pre">Pulses</span></code> are not equivalent:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">pulses</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">sources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">A</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">C</span>
<span class="w">  </span><span class="nt">proportions</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.2</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">time</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">sources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">B</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">C</span>
<span class="w">  </span><span class="nt">proportions</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.2</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">time</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">pulses</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">sources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">B</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">A</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">C</span>
<span class="w">  </span><span class="nt">proportions</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">0.2</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">time</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</pre></div>
</div>
</li>
<li><p>Therefore, we strongly recommend that models be represented using the following
syntax that makes the intended outcome of the model explicit:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">pulses</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">sources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">A</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">B</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">C</span>
<span class="w">  </span><span class="nt">proportions</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">0.2</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">time</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</pre></div>
</div>
</li>
</ul>
</section>
</section>
<section id="migration">
<span id="sec-spec-mdm-migration"></span><h3>Migration<a class="headerlink" href="#migration" title="Link to this heading">#</a></h3>
<p>Continuous asymmetric migration over the half-open time interval
<code class="docutils literal notranslate"><span class="pre">(start_time,</span> <span class="pre">end_time]</span></code>, from the deme with name <code class="docutils literal notranslate"><span class="pre">source</span></code> to the
deme with name <code class="docutils literal notranslate"><span class="pre">dest</span></code>.
Rates are defined as the probability that parents in the “destination”
population are chosen from the “source” population.  Migration rates are thus
per generation and must be less than or equal to one.
There must be at most one migration specified per source/destination pair
for any given time interval.
Furthermore, if more than one source
population have continuous migration into the same destination population, the
sum of those migration rates must also be less than or equal to one, as rates define
probabilities. The probability that parents come from the same population is
just one minus the sum of incoming migration rates.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>When continuous migration occurs over a time period that includes a pulse,
the continuous migration probabilities define the probability of choosing
parents from each deme conditional on individuals not arriving via the pulse.</p>
</div>
<section id="source">
<h4>source<a class="headerlink" href="#source" title="Link to this heading">#</a></h4>
<p>The deme name of the asymmetric migration source.</p>
</section>
<section id="id8">
<h4>dest<a class="headerlink" href="#id8" title="Link to this heading">#</a></h4>
<p>The deme name of the asymmetric migration destination.</p>
</section>
<section id="id9">
<h4>start_time<a class="headerlink" href="#id9" title="Link to this heading">#</a></h4>
<p>The time at which migration begins,
in <a class="reference internal" href="#sec-spec-mdm-time-units"><span class="std std-ref">time_units</span></a> before the present.
The <code class="docutils literal notranslate"><span class="pre">start_time</span></code> must be contained in the
<code class="docutils literal notranslate"><span class="pre">[deme.start_time,</span> <span class="pre">deme.end_time)</span></code> interval of the <code class="docutils literal notranslate"><span class="pre">source</span></code> deme
and the <code class="docutils literal notranslate"><span class="pre">dest</span></code> deme.</p>
</section>
<section id="id10">
<h4>end_time<a class="headerlink" href="#id10" title="Link to this heading">#</a></h4>
<p>The time at which migration stops,
in <a class="reference internal" href="#sec-spec-mdm-time-units"><span class="std std-ref">time_units</span></a> before the present.
The <code class="docutils literal notranslate"><span class="pre">end_time</span></code> must be contained in the
<code class="docutils literal notranslate"><span class="pre">(deme.start_time,</span> <span class="pre">deme.end_time]</span></code> interval of the <code class="docutils literal notranslate"><span class="pre">source</span></code> deme
and the <code class="docutils literal notranslate"><span class="pre">dest</span></code> deme.</p>
</section>
<section id="rate">
<h4>rate<a class="headerlink" href="#rate" title="Link to this heading">#</a></h4>
<p>The rate of migration per generation.</p>
</section>
</section>
<section id="schema">
<span id="sec-spec-mdm-schema"></span><h3>Schema<a class="headerlink" href="#schema" title="Link to this heading">#</a></h3>
<p>The schema listed here is definitive in terms of types and the
structure of the JSON documents that are considered to be
valid instances of the MDM</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">$schema</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://json-schema.org/draft-07/schema#</span>
<span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Fully qualified Demes graph</span>
<span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
<span class="nt">additionalProperties</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="nt">properties</span><span class="p">:</span>
<span class="w">  </span><span class="nt">description</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;string&quot;</span>
<span class="w">  </span><span class="nt">doi</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array</span>
<span class="w">    </span><span class="nt">items</span><span class="p">:</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>

<span class="w">  </span><span class="nt">time_units</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<span class="w">    </span><span class="c1"># TODO: shouldn&#39;t this be an enum?</span>

<span class="w">  </span><span class="nt">generation_time</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;number&quot;</span>
<span class="w">    </span><span class="nt">exclusiveMinimum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>

<span class="w">  </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
<span class="w">    </span><span class="nt">additionalProperties</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">  </span><span class="nt">demes</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array</span>
<span class="w">    </span><span class="nt">minItems</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">    </span><span class="nt">items</span><span class="p">:</span>
<span class="w">      </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/deme&#39;</span>

<span class="w">  </span><span class="nt">pulses</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array</span>
<span class="w">    </span><span class="nt">items</span><span class="p">:</span>
<span class="w">      </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/pulse&#39;</span>

<span class="w">  </span><span class="nt">migrations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array</span>
<span class="w">    </span><span class="nt">items</span><span class="p">:</span>
<span class="w">      </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/migration&#39;</span>

<span class="nt">required</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">description</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">doi</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">time_units</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">demes</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">generation_time</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pulses</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">migrations</span>

<span class="nt">definitions</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>

<span class="w">  </span><span class="nt">rate</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">number</span>
<span class="w">    </span><span class="nt">minimum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="w">    </span><span class="nt">maximum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>

<span class="w">  </span><span class="nt">proportion</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">number</span>
<span class="w">    </span><span class="nt">exclusiveMinimum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="w">    </span><span class="nt">maximum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>

<span class="w">  </span><span class="nt">size</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">number</span>
<span class="w">    </span><span class="nt">exclusiveMinimum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>

<span class="w">  </span><span class="nt">start_time</span><span class="p">:</span>
<span class="w">    </span><span class="nt">oneOf</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">number</span>
<span class="w">        </span><span class="nt">exclusiveMinimum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">const</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Infinity&quot;</span>

<span class="w">  </span><span class="nt">end_time</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">number</span>
<span class="w">    </span><span class="nt">minimum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>

<span class="w">  </span><span class="nt">epoch</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
<span class="w">    </span><span class="nt">additionalProperties</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">    </span><span class="nt">properties</span><span class="p">:</span>
<span class="w">      </span><span class="nt">end_time</span><span class="p">:</span>
<span class="w">        </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/end_time&#39;</span>
<span class="w">      </span><span class="nt">start_size</span><span class="p">:</span>
<span class="w">        </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/size&#39;</span>
<span class="w">      </span><span class="nt">end_size</span><span class="p">:</span>
<span class="w">        </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/size&#39;</span>
<span class="w">      </span><span class="nt">size_function</span><span class="p">:</span>
<span class="w">        </span><span class="c1"># TODO: make this an enumeration</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<span class="w">      </span><span class="nt">cloning_rate</span><span class="p">:</span>
<span class="w">        </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/rate&#39;</span>
<span class="w">      </span><span class="nt">selfing_rate</span><span class="p">:</span>
<span class="w">        </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/rate&#39;</span>
<span class="w">    </span><span class="nt">required</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">end_time</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">start_size</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">end_size</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">size_function</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cloning_rate</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">selfing_rate</span>

<span class="w">  </span><span class="nt">deme</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
<span class="w">    </span><span class="nt">additionalProperties</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">    </span><span class="nt">properties</span><span class="p">:</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span>
<span class="w">        </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/name&#39;</span>
<span class="w">      </span><span class="nt">description</span><span class="p">:</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;string&quot;</span>
<span class="w">      </span><span class="nt">ancestors</span><span class="p">:</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array</span>
<span class="w">        </span><span class="nt">items</span><span class="p">:</span>
<span class="w">          </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/name&#39;</span>
<span class="w">      </span><span class="nt">proportions</span><span class="p">:</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array</span>
<span class="w">        </span><span class="nt">items</span><span class="p">:</span>
<span class="w">          </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/proportion&#39;</span>
<span class="w">      </span><span class="nt">start_time</span><span class="p">:</span>
<span class="w">        </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/start_time&#39;</span>
<span class="w">      </span><span class="nt">epochs</span><span class="p">:</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array</span>
<span class="w">        </span><span class="nt">minItems</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">        </span><span class="nt">items</span><span class="p">:</span>
<span class="w">          </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/epoch&#39;</span>
<span class="w">    </span><span class="nt">required</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">description</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ancestors</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">proportions</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">start_time</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">epochs</span>

<span class="w">  </span><span class="nt">pulse</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
<span class="w">    </span><span class="nt">additionalProperties</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">    </span><span class="nt">properties</span><span class="p">:</span>
<span class="w">      </span><span class="nt">sources</span><span class="p">:</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array</span>
<span class="w">        </span><span class="nt">items</span><span class="p">:</span>
<span class="w">          </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/name&#39;</span>
<span class="w">      </span><span class="nt">dest</span><span class="p">:</span>
<span class="w">        </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/name&#39;</span>
<span class="w">      </span><span class="nt">time</span><span class="p">:</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">number</span>
<span class="w">        </span><span class="nt">exclusiveMinimum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="w">      </span><span class="nt">proportions</span><span class="p">:</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array</span>
<span class="w">        </span><span class="nt">items</span><span class="p">:</span>
<span class="w">          </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/proportion&#39;</span>
<span class="w">    </span><span class="nt">required</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sources</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dest</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">time</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">proportions</span>

<span class="w">  </span><span class="nt">migration</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
<span class="w">    </span><span class="nt">additionalProperties</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">    </span><span class="nt">properties</span><span class="p">:</span>
<span class="w">      </span><span class="nt">source</span><span class="p">:</span>
<span class="w">        </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/name&#39;</span>
<span class="w">      </span><span class="nt">dest</span><span class="p">:</span>
<span class="w">        </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/name&#39;</span>
<span class="w">      </span><span class="nt">start_time</span><span class="p">:</span>
<span class="w">        </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/start_time&#39;</span>
<span class="w">      </span><span class="nt">end_time</span><span class="p">:</span>
<span class="w">        </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/end_time&#39;</span>
<span class="w">      </span><span class="nt">rate</span><span class="p">:</span>
<span class="w">        </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/rate&#39;</span>
<span class="w">    </span><span class="nt">required</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">source</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dest</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">start_time</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">end_time</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rate</span>
</pre></div>
</div>
</section>
</section>
<section id="human-data-model">
<span id="sec-spec-hdm"></span><h2>Human Data Model<a class="headerlink" href="#human-data-model" title="Link to this heading">#</a></h2>
<p>The Demes Human Data Model (HDM) is an extension of the <a class="reference internal" href="#sec-spec-mdm"><span class="std std-ref">Machine Data Model</span></a>
that is designed for human readability. The HDM provides default values
for many parameters, removes redundant information in the MDM via rules described
in this section and also provides a default value replacement mechanism.
JSON documents conforming to the HDM are intended to be processed by a parser,
which outputs the corresponding MDM document.</p>
<p>This section defines the structure of HDM documents, the rules by
which they are transformed into MDM documents, and the error conditions
that should be detected by parsers.</p>
<p>We also provide a <a class="reference internal" href="#sec-spec-reference-implementation"><span class="std std-ref">reference implementation</span></a>
of a parser
for the HDM (which also parses the MDM, by definition) written in Python.
This implementation
is intended to clarify any ambiguities there may be in this specification,
but is not intended to be used directly in downstream software. Please
use the <a class="reference external" href="https://popsim-consortium.github.io/demes-docs/main/introduction.html" title="(in Python)"><span class="xref std std-doc">demes</span></a> Python library instead.</p>
<section id="defaults">
<span id="sec-spec-hdm-defaults"></span><h3>Defaults<a class="headerlink" href="#defaults" title="Link to this heading">#</a></h3>
<p>Repeated values such as shared population sizes represent a significant opportunity
for error in human-generated models. The HDM provides the default value
propagation mechanism to avoid this repetition. The essential idea is that
we declare default values hierarchically within the document, and that
the ultimate value assigned to a property is prioritised by proximity
within the document hierarchy.</p>
<p>Default values can be provided in two places within a HDM document:
at the top-level or within a deme definition.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>See the <a class="reference internal" href="tutorial.html#sec-tutorial-defaults"><span class="std std-ref">tutorial</span></a>
for examples of how the defaults section can be used.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>See the <a class="reference internal" href="#sec-spec-reference-implementation"><span class="std std-ref">reference implementation</span></a>
for a practical example of how defaults in the HDM can be implemented.</p>
</div>
<section id="top-level-defaults">
<span id="sec-spec-hdm-defaults-top-level"></span><h4>Top-level defaults<a class="headerlink" href="#top-level-defaults" title="Link to this heading">#</a></h4>
<p>The top-level HDM document may contain a propery <code class="docutils literal notranslate"><span class="pre">defaults</span></code>,
which defines values to use for entities within rest of the document
<em>unless otherwise specified</em>. The <code class="docutils literal notranslate"><span class="pre">defaults</span></code> object can have
the following properties:</p>
<ul class="simple">
<li><p>epoch: this can specify any property valid for an
<a class="reference internal" href="#sec-spec-mdm-epoch"><span class="std std-ref">MDM epoch</span></a>. All epochs in the
document will be assigned these properties, unless specified
within the epoch or the <a class="reference internal" href="#sec-spec-hdm-defaults-deme"><span class="std std-ref">deme defaults</span></a>.</p></li>
<li><p>migration: this can specify any property valid for an
<a class="reference internal" href="#sec-spec-mdm-migration"><span class="std std-ref">MDM migration</span></a>. All migrations in the
document will be assigned these properties, unless specified
within the migration itself.</p></li>
<li><p>pulse: this can specify any property valid for an
<a class="reference internal" href="#sec-spec-mdm-pulse"><span class="std std-ref">MDM pulse</span></a>. All pulses in the
document will be assigned these properties, unless specified
within the pulse itself.</p></li>
<li><p>deme: this can specify the following properties for a
<a class="reference internal" href="#sec-spec-mdm-deme"><span class="std std-ref">deme</span></a> only: <code class="docutils literal notranslate"><span class="pre">description</span></code>,
<code class="docutils literal notranslate"><span class="pre">ancestors</span></code>, <code class="docutils literal notranslate"><span class="pre">proportions</span></code> and <code class="docutils literal notranslate"><span class="pre">start_time</span></code>.</p></li>
</ul>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>See the <a class="reference internal" href="#sec-spec-hdm-schema"><span class="std std-ref">schema</span></a>
for definitive information on the structural properties of the
top level <code class="docutils literal notranslate"><span class="pre">defaults</span></code> section.</p>
</div>
</section>
<section id="deme-defaults">
<span id="sec-spec-hdm-defaults-deme"></span><h4>Deme defaults<a class="headerlink" href="#deme-defaults" title="Link to this heading">#</a></h4>
<p>Deme defaults operate in the same manner as
<a class="reference internal" href="#sec-spec-hdm-defaults-top-level"><span class="std std-ref">top-level defaults</span></a>: the specified
values will be used if omitted in any epochs within the deme. Defaults
specified within a deme override any values specified in the
<a class="reference internal" href="#sec-spec-hdm-defaults-top-level"><span class="std std-ref">top level</span></a> <code class="docutils literal notranslate"><span class="pre">deme</span></code> defaults.</p>
<p>This can specify any property valid for an
<a class="reference internal" href="#sec-spec-mdm-epoch"><span class="std std-ref">MDM epoch</span></a>. Any epochs in the
deme will be assigned these properties, unless specified
within an epoch itself.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>See the <a class="reference internal" href="#sec-spec-hdm-schema"><span class="std std-ref">schema</span></a>
for definitive information on the structural properties of the
deme <code class="docutils literal notranslate"><span class="pre">defaults</span></code> section.</p>
</div>
</section>
</section>
<section id="resolution">
<span id="sec-spec-hdm-resolution"></span><h3>Resolution<a class="headerlink" href="#resolution" title="Link to this heading">#</a></h3>
<p>The Demes <a class="reference internal" href="#sec-spec-mdm"><span class="std std-ref">machine data model</span></a> contains many
values that are technically redundant, in that they can be reliably
inferred from other values in the model. For example, if a deme’s
<code class="docutils literal notranslate"><span class="pre">size_function</span></code> is <code class="docutils literal notranslate"><span class="pre">&quot;constant&quot;</span></code> during an <a class="reference internal" href="#sec-spec-mdm-epoch"><span class="std std-ref">Epoch</span></a>,
then clearly the <code class="docutils literal notranslate"><span class="pre">start_size</span></code> and <code class="docutils literal notranslate"><span class="pre">end_size</span></code> will be equal.
The MDM still requires that both be specified, because it is intended
for <em>machine</em> consumption, and having a fully specified and complete
data model allows code that consumes this model to be simple and
straightforward. However, such redundancy is a significant
downside for <em>human</em> consumption, where having repeated
or redundant values leads to poorer readability and increases
the probability of errors.
Thus, one of the differences
between the Demes <a class="reference internal" href="#sec-spec-hdm"><span class="std std-ref">Human Data Model</span></a> and <a class="reference internal" href="#sec-spec-mdm"><span class="std std-ref">Machine Data Model</span></a>
is that the HDM tries to remove as much redundancy as possible.
A major part of a Demes parser implementation’s task is to
fill in the redundant information, a process that we refer to
as model “resolution”.
Please consult the
<a class="reference internal" href="#sec-spec-reference-implementation"><span class="std std-ref">reference implementation</span></a>
for more detailed information.</p>
<p>Resolution is idempotent; that is, resolution of an already
resolved model (i.e., in MDM form) MUST result in identical output.
Thus a parser need not know if a model is in HDM or MDM form a priori.</p>
<p>Resolution happens in a set of steps in a defined order:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-time-units"><span class="std std-ref">time_units</span></a></p></li>
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-generation-time"><span class="std std-ref">generation_time</span></a></p></li>
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-metadata"><span class="std std-ref">metadata</span></a></p></li>
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-description"><span class="std std-ref">description</span></a></p></li>
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-doi"><span class="std std-ref">doi</span></a></p></li>
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-defaults"><span class="std std-ref">defaults</span></a></p></li>
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-deme"><span class="std std-ref">demes</span></a></p></li>
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-migration"><span class="std std-ref">migrations</span></a></p></li>
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-pulse"><span class="std std-ref">pulses</span></a></p></li>
</ul>
<div class="admonition-todo admonition" id="id11">
<p class="admonition-title">Todo</p>
<p>Resolution order matters for some things, but not for others.
Clarify where order matters (and why).</p>
</div>
<section id="sec-spec-hdm-resolution-time-units">
<span id="id12"></span><h4>time_units<a class="headerlink" href="#sec-spec-hdm-resolution-time-units" title="Link to this heading">#</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">time_units</span></code> must be specified. The value “generations” is special,
in that it implies that the <code class="docutils literal notranslate"><span class="pre">generation_time</span></code> will be 1 and may thus be omitted.</p>
</section>
<section id="sec-spec-hdm-resolution-generation-time">
<span id="id13"></span><h4>generation_time<a class="headerlink" href="#sec-spec-hdm-resolution-generation-time" title="Link to this heading">#</a></h4>
<p>If <code class="docutils literal notranslate"><span class="pre">time_units</span></code> is not “generations”, then <code class="docutils literal notranslate"><span class="pre">generation_time</span></code>
MUST be specified.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">time_units</span></code> is “generations”, then</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">generation_time</span></code> may be omitted, in which case it
shall be given the value 1.</p></li>
<li><p>an error shall be raised if <code class="docutils literal notranslate"><span class="pre">generation_time</span></code> is not 1.</p></li>
</ul>
</section>
<section id="sec-spec-hdm-resolution-metadata">
<span id="id14"></span><h4>metadata<a class="headerlink" href="#sec-spec-hdm-resolution-metadata" title="Link to this heading">#</a></h4>
<p>If <code class="docutils literal notranslate"><span class="pre">metadata</span></code> is omitted, it shall be given the value of an
empty dictionary.
If <code class="docutils literal notranslate"><span class="pre">metadata</span></code> is present, the value must be a dictionary,
but metadata is otherwise transferred to the output
without further processing. Errors may be raised if metadata is not
parsable (e.g. invalid YAML), but the parser shall not attempt
to validate fields within the metdata.</p>
</section>
<section id="sec-spec-hdm-resolution-description">
<span id="id15"></span><h4>description<a class="headerlink" href="#sec-spec-hdm-resolution-description" title="Link to this heading">#</a></h4>
<p>If <code class="docutils literal notranslate"><span class="pre">description</span></code> is omitted, it shall be given the value of an empty string.</p>
</section>
<section id="sec-spec-hdm-resolution-doi">
<span id="id16"></span><h4>doi<a class="headerlink" href="#sec-spec-hdm-resolution-doi" title="Link to this heading">#</a></h4>
<p>If <code class="docutils literal notranslate"><span class="pre">doi</span></code> is omitted, it shall be given the value of an empty list.</p>
</section>
<section id="sec-spec-hdm-resolution-defaults">
<span id="id17"></span><h4>defaults<a class="headerlink" href="#sec-spec-hdm-resolution-defaults" title="Link to this heading">#</a></h4>
<p>If top-level <code class="docutils literal notranslate"><span class="pre">defaults</span></code> is provided, default values shall be validated
to the extent possible, to avoid propagating invalid values.
E.g. <code class="docutils literal notranslate"><span class="pre">defaults.epoch.start_size</span></code> cannot be negative.</p>
</section>
<section id="deme-resolution">
<span id="sec-spec-hdm-resolution-deme"></span><h4>Deme resolution<a class="headerlink" href="#deme-resolution" title="Link to this heading">#</a></h4>
<p>Each deme is resolved in the order that
it occurs in the input. A deme can only be resolved if its
ancestor demes have already been resolved,
and the parser MUST raise an error if a deme is encountered that
has unresolved ancestors. Thus, valid input files
list the demes in topologically sorted order, such that
ancestors are listed before their descendants.</p>
<p>Resolution order:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-deme-defaults"><span class="std std-ref">defaults</span></a></p></li>
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-deme-description"><span class="std std-ref">description</span></a></p></li>
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-deme-ancestors"><span class="std std-ref">ancestors</span></a></p></li>
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-deme-proportions"><span class="std std-ref">proportions</span></a></p></li>
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-deme-start-time"><span class="std std-ref">start_time</span></a></p></li>
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-epoch"><span class="std std-ref">epochs</span></a></p></li>
</ul>
<section id="sec-spec-hdm-resolution-deme-defaults">
<span id="id18"></span><h5>defaults<a class="headerlink" href="#sec-spec-hdm-resolution-deme-defaults" title="Link to this heading">#</a></h5>
<p>If deme-level <code class="docutils literal notranslate"><span class="pre">defaults</span></code> is provided, default values shall be validated
to the extent possible, to avoid propagating invalid values.
E.g. <code class="docutils literal notranslate"><span class="pre">defaults.epoch.start_size</span></code> cannot be negative.</p>
<p>For each deme, deme-level <code class="docutils literal notranslate"><span class="pre">defaults</span></code> override top-level defaults.</p>
</section>
<section id="sec-spec-hdm-resolution-deme-description">
<span id="id19"></span><h5>description<a class="headerlink" href="#sec-spec-hdm-resolution-deme-description" title="Link to this heading">#</a></h5>
<p>If <code class="docutils literal notranslate"><span class="pre">description</span></code> is omitted,</p>
<ul class="simple">
<li><p>If the <code class="docutils literal notranslate"><span class="pre">deme.description</span></code> defaults field is present, <code class="docutils literal notranslate"><span class="pre">description</span></code>
shall be given this value.</p></li>
<li><p>Otherwise, <code class="docutils literal notranslate"><span class="pre">description</span></code> shall be given the value of the empty string.</p></li>
</ul>
</section>
<section id="sec-spec-hdm-resolution-deme-ancestors">
<span id="id20"></span><h5>ancestors<a class="headerlink" href="#sec-spec-hdm-resolution-deme-ancestors" title="Link to this heading">#</a></h5>
<p>If <code class="docutils literal notranslate"><span class="pre">ancestors</span></code> is omitted,</p>
<ul class="simple">
<li><p>If the <code class="docutils literal notranslate"><span class="pre">deme.ancestors</span></code> defaults field is present, <code class="docutils literal notranslate"><span class="pre">ancestors</span></code>
shall be given this value.</p></li>
<li><p>Otherwise, <code class="docutils literal notranslate"><span class="pre">ancestors</span></code> shall be given the value of the empty list.</p></li>
</ul>
</section>
<section id="sec-spec-hdm-resolution-deme-proportions">
<span id="id21"></span><h5>proportions<a class="headerlink" href="#sec-spec-hdm-resolution-deme-proportions" title="Link to this heading">#</a></h5>
<p>If <code class="docutils literal notranslate"><span class="pre">proportions</span></code> is omitted,</p>
<ul class="simple">
<li><p>If the <code class="docutils literal notranslate"><span class="pre">deme.proportions</span></code> defaults field is present, <code class="docutils literal notranslate"><span class="pre">proportions</span></code>
shall be given this value.</p></li>
<li><p>Otherwise, if <code class="docutils literal notranslate"><span class="pre">ancestors</span></code> has length one, <code class="docutils literal notranslate"><span class="pre">proportions</span></code> shall be
a single-element list containing the element <code class="docutils literal notranslate"><span class="pre">1.0</span></code>.</p></li>
<li><p>Otherwise, if <code class="docutils literal notranslate"><span class="pre">ancestors</span></code> has length zero,
<code class="docutils literal notranslate"><span class="pre">proportions</span></code> shall be given the value of the empty list.</p></li>
<li><p>Otherwise, <code class="docutils literal notranslate"><span class="pre">proportions</span></code> cannot be determined and an error
MUST be raised.</p></li>
</ul>
</section>
<section id="sec-spec-hdm-resolution-deme-start-time">
<span id="id22"></span><h5>start_time<a class="headerlink" href="#sec-spec-hdm-resolution-deme-start-time" title="Link to this heading">#</a></h5>
<p>If <code class="docutils literal notranslate"><span class="pre">start_time</span></code> is omitted,</p>
<ul class="simple">
<li><p>If the <code class="docutils literal notranslate"><span class="pre">epoch.start_time</span></code> defaults field is present, <code class="docutils literal notranslate"><span class="pre">start_time</span></code>
shall be given this value.</p></li>
<li><p>Otherwise, if <code class="docutils literal notranslate"><span class="pre">ancestors</span></code> has length one and the ancestor has an
<code class="docutils literal notranslate"><span class="pre">end_time</span> <span class="pre">&gt;</span> <span class="pre">0</span></code>, the ancestor’s <code class="docutils literal notranslate"><span class="pre">end_time</span></code> value shall be used.</p></li>
<li><p>Otherwise, if <code class="docutils literal notranslate"><span class="pre">ancestors</span></code> has length zero, <code class="docutils literal notranslate"><span class="pre">start_time</span></code> shall be
given the value <code class="docutils literal notranslate"><span class="pre">infinity</span></code>.</p></li>
<li><p>Otherwise, <code class="docutils literal notranslate"><span class="pre">start_time</span></code> cannot be determined and an
error MUST be raised.</p></li>
</ul>
</section>
<section id="epoch-resolution">
<span id="sec-spec-hdm-resolution-epoch"></span><h5>Epoch resolution<a class="headerlink" href="#epoch-resolution" title="Link to this heading">#</a></h5>
<p>Epochs are listed in time-descending order (from oldest to youngest),
and population sizes are inherited from older epochs.
Resolution order:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-epoch-end-time"><span class="std std-ref">end_time</span></a></p></li>
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-epoch-size"><span class="std std-ref">start_size, end_size</span></a></p></li>
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-epoch-size-function"><span class="std std-ref">size_function</span></a></p></li>
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-epoch-selfing-rate"><span class="std std-ref">selfing_rate</span></a></p></li>
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-epoch-cloning-rate"><span class="std std-ref">cloning_rate</span></a></p></li>
</ul>
<p>If a deme’s <code class="docutils literal notranslate"><span class="pre">epochs</span></code> field is omitted, it will be given the value of
a single-element list, where the list element has the value of an epoch with
all fields omitted. This may produce a valid epoch during subsequent resolution,
e.g. if the <code class="docutils literal notranslate"><span class="pre">epoch.start_size</span></code> defaults field has a value.</p>
<section id="sec-spec-hdm-resolution-epoch-end-time">
<span id="id23"></span><h6>end_time<a class="headerlink" href="#sec-spec-hdm-resolution-epoch-end-time" title="Link to this heading">#</a></h6>
<p>If <code class="docutils literal notranslate"><span class="pre">end_time</span></code> is omitted,</p>
<ul class="simple">
<li><p>If the <code class="docutils literal notranslate"><span class="pre">epoch.end_time</span></code> defaults field is present, <code class="docutils literal notranslate"><span class="pre">end_time</span></code>
shall be given this value.</p></li>
<li><p>Otherwise, if this is the last epoch, <code class="docutils literal notranslate"><span class="pre">end_time</span></code> shall be
given the value <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p></li>
<li><p>Otherwise, <code class="docutils literal notranslate"><span class="pre">end_time</span></code> cannot be determined and an error MUST
be raised.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">end_time</span></code> value of the first epoch MUST be strictly
smaller than the deme’s <code class="docutils literal notranslate"><span class="pre">start_time</span></code>.
The <code class="docutils literal notranslate"><span class="pre">end_time</span></code> values of successive epochs MUST be strictly decreasing.</p>
</section>
<section id="start-size-end-size">
<span id="sec-spec-hdm-resolution-epoch-size"></span><h6>start_size, end_size<a class="headerlink" href="#start-size-end-size" title="Link to this heading">#</a></h6>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Sizes are never inherited from ancestors.</p>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">start_size</span></code> is omitted and the <code class="docutils literal notranslate"><span class="pre">epoch.start_size</span></code> defaults field
is present, then the epoch’s <code class="docutils literal notranslate"><span class="pre">start_size</span></code> shall be given this value.
If <code class="docutils literal notranslate"><span class="pre">end_size</span></code> is omitted and the <code class="docutils literal notranslate"><span class="pre">epoch.end_size</span></code> defaults field
is present, then the epoch’s <code class="docutils literal notranslate"><span class="pre">end_size</span></code> shall be given this value.</p>
<p>In the first epoch,</p>
<ul class="simple">
<li><p>at least one of <code class="docutils literal notranslate"><span class="pre">start_size</span></code> or <code class="docutils literal notranslate"><span class="pre">end_size</span></code>
MUST be specified (possibly via a defaults field).</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">start_size</span></code> is omitted (and no default exists),
it shall be given the same value as <code class="docutils literal notranslate"><span class="pre">end_size</span></code>.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">end_size</span></code> is omitted (and no default exists),
it shall be given the same value as <code class="docutils literal notranslate"><span class="pre">start_size</span></code>.</p></li>
<li><p>If the deme’s <code class="docutils literal notranslate"><span class="pre">start_time</span></code> is infinite, <code class="docutils literal notranslate"><span class="pre">start_size</span></code>
MUST have the same value as <code class="docutils literal notranslate"><span class="pre">end_size</span></code>.</p></li>
</ul>
<p>In subsequent epochs,</p>
<ul class="simple">
<li><p>If <code class="docutils literal notranslate"><span class="pre">start_size</span></code> is omitted (and no defaults exist),
it shall be given the same value as the previous epoch’s <code class="docutils literal notranslate"><span class="pre">end_size</span></code>.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">end_size</span></code> is omitted (and no defaults exist),
it shall be given the same value as <code class="docutils literal notranslate"><span class="pre">start_size</span></code>.</p></li>
</ul>
</section>
<section id="sec-spec-hdm-resolution-epoch-size-function">
<span id="id24"></span><h6>size_function<a class="headerlink" href="#sec-spec-hdm-resolution-epoch-size-function" title="Link to this heading">#</a></h6>
<p>If <code class="docutils literal notranslate"><span class="pre">size_function</span></code> is omitted,</p>
<ul class="simple">
<li><p>if the <code class="docutils literal notranslate"><span class="pre">epoch.size_function</span></code> defaults field is present,
<code class="docutils literal notranslate"><span class="pre">size_function</span></code> shall be given this value.</p></li>
<li><p>Otherwise, if <code class="docutils literal notranslate"><span class="pre">start_size</span></code> has the same value as <code class="docutils literal notranslate"><span class="pre">end_size</span></code>,
<code class="docutils literal notranslate"><span class="pre">size_function</span></code> will be given the value <code class="docutils literal notranslate"><span class="pre">&quot;constant&quot;</span></code>.</p></li>
<li><p>Otherwise, <code class="docutils literal notranslate"><span class="pre">size_function</span></code> will be given the value <code class="docutils literal notranslate"><span class="pre">&quot;exponential&quot;</span></code>.</p></li>
</ul>
</section>
<section id="sec-spec-hdm-resolution-epoch-selfing-rate">
<span id="id25"></span><h6>selfing_rate<a class="headerlink" href="#sec-spec-hdm-resolution-epoch-selfing-rate" title="Link to this heading">#</a></h6>
<p>If <code class="docutils literal notranslate"><span class="pre">selfing_rate</span></code> is omitted,</p>
<ul class="simple">
<li><p>if the <code class="docutils literal notranslate"><span class="pre">epoch.selfing_rate</span></code> defaults field is present,
<code class="docutils literal notranslate"><span class="pre">selfing_rate</span></code> shall be given this value.</p></li>
<li><p>Otherwise, <code class="docutils literal notranslate"><span class="pre">selfing_rate</span></code> shall be given the value <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p></li>
</ul>
</section>
<section id="sec-spec-hdm-resolution-epoch-cloning-rate">
<span id="id26"></span><h6>cloning_rate<a class="headerlink" href="#sec-spec-hdm-resolution-epoch-cloning-rate" title="Link to this heading">#</a></h6>
<p>If <code class="docutils literal notranslate"><span class="pre">cloning_rate</span></code> is omitted,</p>
<ul class="simple">
<li><p>if the <code class="docutils literal notranslate"><span class="pre">epoch.cloning_rate</span></code> defaults field is present,
<code class="docutils literal notranslate"><span class="pre">cloning_rate</span></code> shall be given this value.</p></li>
<li><p>Otherwise, <code class="docutils literal notranslate"><span class="pre">cloning_rate</span></code> shall be given the value <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p></li>
</ul>
</section>
</section>
</section>
<section id="migration-resolution">
<span id="sec-spec-hdm-resolution-migration"></span><h4>Migration resolution<a class="headerlink" href="#migration-resolution" title="Link to this heading">#</a></h4>
<p>Migrations must be resolved after all demes are resolved.
Asymmetric migration can be specified using the <code class="docutils literal notranslate"><span class="pre">source</span></code>
and <code class="docutils literal notranslate"><span class="pre">dest</span></code> properties, or symmetric migration can be
specified using the <code class="docutils literal notranslate"><span class="pre">demes</span></code> property to list the names
of the participating demes. Each symmetric migration is resolved
into two asymmetric migrations (one in each direction) for each
pair of participating demes.</p>
<p>Resolution order:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-migration-rate"><span class="std std-ref">rate</span></a></p></li>
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-migration-source"><span class="std std-ref">source</span></a></p></li>
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-migration-dest"><span class="std std-ref">dest</span></a></p></li>
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-migration-demes"><span class="std std-ref">demes</span></a></p></li>
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-migration-symmetric"><span class="std std-ref">Symmetric migration</span></a></p></li>
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-migration-start-time"><span class="std std-ref">start_time</span></a></p></li>
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-migration-end-time"><span class="std std-ref">end_time</span></a></p></li>
</ul>
<section id="sec-spec-hdm-resolution-migration-rate">
<span id="id27"></span><h5>rate<a class="headerlink" href="#sec-spec-hdm-resolution-migration-rate" title="Link to this heading">#</a></h5>
<p>If the <code class="docutils literal notranslate"><span class="pre">rate</span></code> is omitted,</p>
<ul class="simple">
<li><p>if the <code class="docutils literal notranslate"><span class="pre">migration.rate</span></code> defaults field is present,
<code class="docutils literal notranslate"><span class="pre">rate</span></code> shall be given this value.</p></li>
<li><p>Otherwise, an error MUST be raised.</p></li>
</ul>
</section>
<section id="sec-spec-hdm-resolution-migration-source">
<span id="id28"></span><h5>source<a class="headerlink" href="#sec-spec-hdm-resolution-migration-source" title="Link to this heading">#</a></h5>
<p>If <code class="docutils literal notranslate"><span class="pre">source</span></code> is omitted and the <code class="docutils literal notranslate"><span class="pre">migration.source</span></code> defaults field is present,
<code class="docutils literal notranslate"><span class="pre">source</span></code> shall be given this value.</p>
</section>
<section id="sec-spec-hdm-resolution-migration-dest">
<span id="id29"></span><h5>dest<a class="headerlink" href="#sec-spec-hdm-resolution-migration-dest" title="Link to this heading">#</a></h5>
<p>If <code class="docutils literal notranslate"><span class="pre">dest</span></code> is omitted and the <code class="docutils literal notranslate"><span class="pre">migration.dest</span></code> defaults field is present,
<code class="docutils literal notranslate"><span class="pre">dest</span></code> shall be given this value.</p>
</section>
<section id="sec-spec-hdm-resolution-migration-demes">
<span id="id30"></span><h5>demes<a class="headerlink" href="#sec-spec-hdm-resolution-migration-demes" title="Link to this heading">#</a></h5>
<p>If <code class="docutils literal notranslate"><span class="pre">demes</span></code> is omitted and the <code class="docutils literal notranslate"><span class="pre">migration.demes</span></code> defaults field is present,
<code class="docutils literal notranslate"><span class="pre">demes</span></code> shall be given this value.</p>
</section>
<section id="symmetric-migration">
<span id="sec-spec-hdm-resolution-migration-symmetric"></span><h5>Symmetric migration<a class="headerlink" href="#symmetric-migration" title="Link to this heading">#</a></h5>
<p>The following rules shall determine the mode of migration
(either asymmetric or symmetric):</p>
<ul class="simple">
<li><p>If <code class="docutils literal notranslate"><span class="pre">demes</span></code> does not have a value, and both <code class="docutils literal notranslate"><span class="pre">source</span></code> and <code class="docutils literal notranslate"><span class="pre">dest</span></code> have values,
the migration is asymmetric.
Resolution continues from <a class="reference internal" href="#sec-spec-hdm-resolution-migration-start-time"><span class="std std-ref">start_time</span></a>.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">demes</span></code> has a value, and neither <code class="docutils literal notranslate"><span class="pre">source</span></code> nor <code class="docutils literal notranslate"><span class="pre">dest</span></code> have values,
the migration is symmetric.</p></li>
<li><p>Otherwise, the mode of migration cannot be determined,
and an error MUST be raised.</p></li>
</ul>
<p>If the migration is symmetric, <code class="docutils literal notranslate"><span class="pre">demes</span></code> MUST be validated
before further resolution:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">demes</span></code> MUST be a list of at least two deme names.</p></li>
<li><p>Each element of <code class="docutils literal notranslate"><span class="pre">demes</span></code> must be unique.</p></li>
<li><p>Each element of <code class="docutils literal notranslate"><span class="pre">demes</span></code> must be the name of a resolved deme.</p></li>
</ul>
<p>If any of the previous conditions are not met, an error MUST be raised.</p>
<p>If the migration is symmetric, two new asymmetric migrations shall be
constructed for each pair of deme names in <code class="docutils literal notranslate"><span class="pre">demes</span></code>.
E.g. if <code class="docutils literal notranslate"><span class="pre">demes</span> <span class="pre">=</span> <span class="pre">[&quot;a&quot;,</span> <span class="pre">&quot;b&quot;,</span> <span class="pre">&quot;c&quot;]</span></code>, then asymmetric migrations shall
be constructed for the following cases:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">source=&quot;a&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">dest=&quot;b&quot;</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">source=&quot;b&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">dest=&quot;a&quot;</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">source=&quot;a&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">dest=&quot;c&quot;</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">source=&quot;c&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">dest=&quot;a&quot;</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">source=&quot;b&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">dest=&quot;c&quot;</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">source=&quot;c&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">dest=&quot;b&quot;</span></code>.</p></li>
</ul>
<p>Values for <code class="docutils literal notranslate"><span class="pre">rate</span></code>, <code class="docutils literal notranslate"><span class="pre">start_time</span></code>, and <code class="docutils literal notranslate"><span class="pre">end_time</span></code> for the new asymmetric
migrations shall be taken from the symmetric migration.
If <code class="docutils literal notranslate"><span class="pre">start_time</span></code> and/or <code class="docutils literal notranslate"><span class="pre">end_time</span></code> are omitted from the symmetric
migration, these shall also be omitted for the new asymmetric migrations.
Resolution now proceeds separately for each distinct asymmetric migration.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The symmetric migration shall not appear in the MDM output.
Once the symmetric migration has been resolved into the corresponding
asymmetric migrations, the symmetric migration may be discarded.</p>
</div>
</section>
<section id="sec-spec-hdm-resolution-migration-start-time">
<span id="id31"></span><h5>start_time<a class="headerlink" href="#sec-spec-hdm-resolution-migration-start-time" title="Link to this heading">#</a></h5>
<p>If <code class="docutils literal notranslate"><span class="pre">start_time</span></code> is omitted,</p>
<ul class="simple">
<li><p>If the <code class="docutils literal notranslate"><span class="pre">migration.start_time</span></code> defaults field has a value,
<code class="docutils literal notranslate"><span class="pre">start_time</span></code> shall be given this value.</p></li>
<li><p>Otherwise, <code class="docutils literal notranslate"><span class="pre">start_time</span></code> shall be the oldest time at which
both the <code class="docutils literal notranslate"><span class="pre">source</span></code> and <code class="docutils literal notranslate"><span class="pre">dest</span></code> demes exist.
I.e. <code class="docutils literal notranslate"><span class="pre">min(source.start_time,</span> <span class="pre">dest.start_time)</span></code>.</p></li>
</ul>
</section>
<section id="sec-spec-hdm-resolution-migration-end-time">
<span id="id32"></span><h5>end_time<a class="headerlink" href="#sec-spec-hdm-resolution-migration-end-time" title="Link to this heading">#</a></h5>
<p>If <code class="docutils literal notranslate"><span class="pre">end_time</span></code> is omitted,</p>
<ul class="simple">
<li><p>If the <code class="docutils literal notranslate"><span class="pre">migration.end_time</span></code> defaults field has a value,
<code class="docutils literal notranslate"><span class="pre">end_time</span></code> shall be given this value.</p></li>
<li><p>Otherwise, <code class="docutils literal notranslate"><span class="pre">end_time</span></code> shall be the most recent time at which
both the <code class="docutils literal notranslate"><span class="pre">source</span></code> and <code class="docutils literal notranslate"><span class="pre">dest</span></code> demes exist.
I.e. <code class="docutils literal notranslate"><span class="pre">max(source.end_time,</span> <span class="pre">dest.end_time)</span></code>.</p></li>
</ul>
</section>
</section>
<section id="pulse-resolution">
<span id="sec-spec-hdm-resolution-pulse"></span><h4>Pulse resolution<a class="headerlink" href="#pulse-resolution" title="Link to this heading">#</a></h4>
<p>Pulses must be resolved after all demes are resolved.</p>
<p>Resolution order:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-pulse-sources"><span class="std std-ref">sources</span></a></p></li>
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-pulse-proportions"><span class="std std-ref">proportions</span></a></p></li>
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-pulse-dest"><span class="std std-ref">dest</span></a></p></li>
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-pulse-time"><span class="std std-ref">time</span></a></p></li>
<li><p><a class="reference internal" href="#sec-spec-hdm-resolution-pulse-sort"><span class="std std-ref">Sort pulses</span></a></p></li>
</ul>
<section id="sec-spec-hdm-resolution-pulse-sources">
<span id="id33"></span><h5>sources<a class="headerlink" href="#sec-spec-hdm-resolution-pulse-sources" title="Link to this heading">#</a></h5>
<p>If <code class="docutils literal notranslate"><span class="pre">sources</span></code> is omitted,</p>
<ul class="simple">
<li><p>if the <code class="docutils literal notranslate"><span class="pre">pulse.sources</span></code> defaults field has a value,
<code class="docutils literal notranslate"><span class="pre">sources</span></code> shall be given this value.</p></li>
<li><p>Otherwise, an error MUST be raised.</p></li>
</ul>
</section>
<section id="sec-spec-hdm-resolution-pulse-proportions">
<span id="id34"></span><h5>proportions<a class="headerlink" href="#sec-spec-hdm-resolution-pulse-proportions" title="Link to this heading">#</a></h5>
<p>If <code class="docutils literal notranslate"><span class="pre">proportions</span></code> is omitted,</p>
<ul class="simple">
<li><p>if the <code class="docutils literal notranslate"><span class="pre">pulse.proportions</span></code> defaults field has a value,
<code class="docutils literal notranslate"><span class="pre">proportions</span></code> shall be given this value.</p></li>
<li><p>Otherwise, an error MUST be raised.</p></li>
</ul>
</section>
<section id="sec-spec-hdm-resolution-pulse-dest">
<span id="id35"></span><h5>dest<a class="headerlink" href="#sec-spec-hdm-resolution-pulse-dest" title="Link to this heading">#</a></h5>
<p>If <code class="docutils literal notranslate"><span class="pre">dest</span></code> is omitted,</p>
<ul class="simple">
<li><p>if the <code class="docutils literal notranslate"><span class="pre">pulse.dest</span></code> defaults field has a value,
<code class="docutils literal notranslate"><span class="pre">dest</span></code> shall be given this value.</p></li>
<li><p>Otherwise, an error MUST be raised.</p></li>
</ul>
</section>
<section id="sec-spec-hdm-resolution-pulse-time">
<span id="id36"></span><h5>time<a class="headerlink" href="#sec-spec-hdm-resolution-pulse-time" title="Link to this heading">#</a></h5>
<p>If <code class="docutils literal notranslate"><span class="pre">time</span></code> is omitted,</p>
<ul class="simple">
<li><p>if the <code class="docutils literal notranslate"><span class="pre">pulse.time</span></code> defaults field has a value,
<code class="docutils literal notranslate"><span class="pre">time</span></code> shall be given this value.</p></li>
<li><p>Otherwise, an error MUST be raised.</p></li>
</ul>
</section>
<section id="sort-pulses">
<span id="sec-spec-hdm-resolution-pulse-sort"></span><h5>Sort pulses<a class="headerlink" href="#sort-pulses" title="Link to this heading">#</a></h5>
<p>Pulses MUST be sorted in time-descending order (from oldest to youngest).
A <a class="reference external" href="https://en.wikipedia.org/wiki/Sorting_algorithm#Stability">stable</a>
sorting algorithm MUST be used to avoid changing the model interpretation
when multiple pulses are specified with the same <code class="docutils literal notranslate"><span class="pre">time</span></code> value.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In a discrete-time setting, non-integer pulse times that are distinct
could be rounded to the same time value. If pulses are in time-ascending
order when times are rounded, then the pulses would be applied
in the opposite order compared to a continuous-time setting.
Sorting in time-descending order avoids this discrepancy.</p>
</div>
</section>
</section>
</section>
<section id="validation">
<span id="sec-spec-hdm-validation"></span><h3>Validation<a class="headerlink" href="#validation" title="Link to this heading">#</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It may be convenient to perform some or all validation during model resolution.
E.g. to avoid code duplication, or to provide better error messages to the user.</p>
</div>
<p>Following resolution, the model must be validated against the MDM schema.
This includes checking:</p>
<ul class="simple">
<li><p>all required properties now have values,</p></li>
<li><p>no additional properties are present (except where permitted by the schema),</p></li>
<li><p>the types of properties match the schema,</p></li>
<li><p>the values are within the ranges specified
(noting that infinity is permitted only for deme <code class="docutils literal notranslate"><span class="pre">start_time</span></code>
and for migration <code class="docutils literal notranslate"><span class="pre">start_time</span></code>).</p></li>
</ul>
<p>In addition to validation against the schema, the following constraints
must be checked to ensure overall consistency of the model.
If any condition is not met, an error must be raised.</p>
<section id="id37">
<h4>generation_time<a class="headerlink" href="#id37" title="Link to this heading">#</a></h4>
<p>If <code class="docutils literal notranslate"><span class="pre">time_units</span></code> is “generations”, then <code class="docutils literal notranslate"><span class="pre">generation_time</span></code> must be 1.</p>
</section>
<section id="id38">
<h4>demes<a class="headerlink" href="#id38" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>There must be at least one deme.</p></li>
<li><p>Each deme’s <code class="docutils literal notranslate"><span class="pre">name</span></code> must be unique in the model.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code> must be a valid Python identifier.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">start_time</span></code> is infinity, <code class="docutils literal notranslate"><span class="pre">ancestors</span></code> must be an empty list.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">ancestors</span></code> is an empty list, <code class="docutils literal notranslate"><span class="pre">start_time</span></code> must have the value infinity.</p></li>
<li><p>No deme may appear in its own <code class="docutils literal notranslate"><span class="pre">ancestors</span></code> list.</p></li>
<li><p>Each element of the <code class="docutils literal notranslate"><span class="pre">ancestors</span></code> list must be unique.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">proportions</span></code> list must have the same length as the <code class="docutils literal notranslate"><span class="pre">ancestors</span></code> list.</p></li>
<li><p>If the <code class="docutils literal notranslate"><span class="pre">proportions</span></code> list is not empty, then the values must sum to 1
(within a reasonable tolerance, e.g. 1e-9).</p></li>
</ul>
<section id="id39">
<h5>epochs<a class="headerlink" href="#id39" title="Link to this heading">#</a></h5>
<ul class="simple">
<li><p>Each deme must have at least one epoch.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">end_time</span></code> values of successive epochs must be strictly descending
(ordered from the past towards the present).</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">end_time</span></code> values must be strictly smaller than the deme’s <code class="docutils literal notranslate"><span class="pre">start_time</span></code>.</p></li>
<li><p>If the deme has an infinite <code class="docutils literal notranslate"><span class="pre">start_time</span></code>, the first epoch’s <code class="docutils literal notranslate"><span class="pre">size_function</span></code>
must have the value “constant”.</p></li>
<li><p>If the <code class="docutils literal notranslate"><span class="pre">size_function</span></code> is “constant”, the <code class="docutils literal notranslate"><span class="pre">start_size</span></code> and <code class="docutils literal notranslate"><span class="pre">end_size</span></code>
must be equal.</p></li>
</ul>
</section>
</section>
<section id="id40">
<h4>migrations<a class="headerlink" href="#id40" title="Link to this heading">#</a></h4>
<p>This section assumes that symmetric migrations have been resolved into
pairs of asymmetric migrations and validated as per the
<a class="reference internal" href="#sec-spec-hdm-resolution-migration"><span class="std std-ref">migration resolution</span></a>
section. Resolution of symmetric migrations includes
validation of the <code class="docutils literal notranslate"><span class="pre">migration.demes</span></code> property, and this property
is not considered below as it is not part of the MDM.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">source</span></code> must not be the same as <code class="docutils literal notranslate"><span class="pre">dest</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">start_time</span></code> and <code class="docutils literal notranslate"><span class="pre">end_time</span></code> must both be in the closed interval
<code class="docutils literal notranslate"><span class="pre">[deme.start_time,</span> <span class="pre">deme.end_time]</span></code>, for both the <code class="docutils literal notranslate"><span class="pre">source</span></code> deme
and the <code class="docutils literal notranslate"><span class="pre">dest</span></code> deme.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">start_time</span></code> must be strictly greater than <code class="docutils literal notranslate"><span class="pre">end_time</span></code>.</p></li>
<li><p>There must be at most one migration specified per source/destination pair
for any given time interval.</p></li>
<li><p>If more than one source population have continuous migration into the same
destination population, the sum of those migration rates must also be less
than or equal to 1
(within a reasonable tolerance, e.g. 1e-9).</p></li>
</ul>
</section>
<section id="id41">
<h4>pulses<a class="headerlink" href="#id41" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">sources</span></code> must be list containing at least one element.</p></li>
<li><p>Each element of <code class="docutils literal notranslate"><span class="pre">sources</span></code> must be unique.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">dest</span></code> deme must not appear in the <code class="docutils literal notranslate"><span class="pre">sources</span></code> list.</p></li>
<li><p>For each source deme in <code class="docutils literal notranslate"><span class="pre">sources</span></code>,
<code class="docutils literal notranslate"><span class="pre">time</span></code> must be in the open-closed interval <code class="docutils literal notranslate"><span class="pre">(deme.start_time,</span> <span class="pre">deme.end_time]</span></code>,
defined by the existence interval of the source deme.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">time</span></code> must be in the closed-open interval <code class="docutils literal notranslate"><span class="pre">[deme.start_time,</span> <span class="pre">deme.end_time)</span></code>,
defined by the existence interval of the <code class="docutils literal notranslate"><span class="pre">dest</span></code> deme.</p></li>
<li><p>Hence, <code class="docutils literal notranslate"><span class="pre">time</span></code> must not have the value infinity, nor the value 0.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">proportions</span></code> list must have the same length as the <code class="docutils literal notranslate"><span class="pre">sources</span></code> list.</p></li>
<li><p>The sum of values in the <code class="docutils literal notranslate"><span class="pre">proportions</span></code> list must be less than or equal to 1
(within a reasonable tolerance, e.g. 1e-9).</p></li>
</ul>
</section>
</section>
<section id="sec-spec-hdm-schema">
<span id="id42"></span><h3>Schema<a class="headerlink" href="#sec-spec-hdm-schema" title="Link to this heading">#</a></h3>
<p>The schema listed here is definitive in terms of types and the
structure of the JSON documents that are considered to be
valid instances of the Demes standard.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">$schema</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://json-schema.org/draft-07/schema#</span>
<span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Demes graph</span>
<span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
<span class="nt">additionalProperties</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="nt">properties</span><span class="p">:</span>
<span class="w">  </span><span class="nt">description</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;string&quot;</span>
<span class="w">    </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">  </span><span class="nt">doi</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array</span>
<span class="w">    </span><span class="nt">items</span><span class="p">:</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<span class="w">    </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>

<span class="w">  </span><span class="nt">time_units</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<span class="w">    </span><span class="c1"># TODO: shouldn&#39;t this be an enum?</span>

<span class="w">  </span><span class="nt">generation_time</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;number&quot;</span>
<span class="w">    </span><span class="nt">exclusiveMinimum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>

<span class="w">  </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
<span class="w">    </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="w">    </span><span class="nt">additionalProperties</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">  </span><span class="nt">defaults</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
<span class="w">    </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="w">    </span><span class="nt">additionalProperties</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">    </span><span class="nt">properties</span><span class="p">:</span>
<span class="w">      </span><span class="nt">epoch</span><span class="p">:</span>
<span class="w">        </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/epoch&#39;</span>
<span class="w">      </span><span class="nt">migration</span><span class="p">:</span>
<span class="w">        </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/migration&#39;</span>
<span class="w">      </span><span class="nt">pulse</span><span class="p">:</span>
<span class="w">        </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/pulse&#39;</span>
<span class="w">      </span><span class="nt">deme</span><span class="p">:</span>
<span class="w">        </span><span class="nt">properties</span><span class="p">:</span>
<span class="w">          </span><span class="nt">description</span><span class="p">:</span>
<span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;string&quot;</span>
<span class="w">          </span><span class="nt">ancestors</span><span class="p">:</span>
<span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array</span>
<span class="w">            </span><span class="nt">items</span><span class="p">:</span>
<span class="w">              </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/name&#39;</span>
<span class="w">          </span><span class="nt">proportions</span><span class="p">:</span>
<span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array</span>
<span class="w">            </span><span class="nt">items</span><span class="p">:</span>
<span class="w">              </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/proportion&#39;</span>
<span class="w">          </span><span class="nt">start_time</span><span class="p">:</span>
<span class="w">            </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/start_time&#39;</span>

<span class="w">  </span><span class="nt">demes</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array</span>
<span class="w">    </span><span class="nt">minItems</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">    </span><span class="nt">items</span><span class="p">:</span>
<span class="w">      </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/deme&#39;</span>

<span class="w">  </span><span class="nt">pulses</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array</span>
<span class="w">    </span><span class="nt">items</span><span class="p">:</span>
<span class="w">      </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/pulse&#39;</span>
<span class="w">    </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>

<span class="w">  </span><span class="nt">migrations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array</span>
<span class="w">    </span><span class="nt">items</span><span class="p">:</span>
<span class="w">      </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/migration&#39;</span>
<span class="w">    </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>

<span class="nt">required</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">time_units</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">demes</span>

<span class="nt">definitions</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>

<span class="w">  </span><span class="nt">rate</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">number</span>
<span class="w">    </span><span class="nt">minimum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="w">    </span><span class="nt">maximum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>

<span class="w">  </span><span class="nt">proportion</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">number</span>
<span class="w">    </span><span class="nt">exclusiveMinimum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="w">    </span><span class="nt">maximum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>

<span class="w">  </span><span class="nt">size</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">number</span>
<span class="w">    </span><span class="nt">exclusiveMinimum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>

<span class="w">  </span><span class="nt">start_time</span><span class="p">:</span>
<span class="w">    </span><span class="nt">oneOf</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">number</span>
<span class="w">        </span><span class="nt">exclusiveMinimum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">const</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Infinity&quot;</span>

<span class="w">  </span><span class="nt">end_time</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">number</span>
<span class="w">    </span><span class="nt">minimum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>

<span class="w">  </span><span class="nt">epoch</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
<span class="w">    </span><span class="nt">additionalProperties</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">    </span><span class="nt">properties</span><span class="p">:</span>
<span class="w">      </span><span class="nt">end_time</span><span class="p">:</span>
<span class="w">        </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/end_time&#39;</span>
<span class="w">      </span><span class="nt">start_size</span><span class="p">:</span>
<span class="w">        </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/size&#39;</span>
<span class="w">      </span><span class="nt">end_size</span><span class="p">:</span>
<span class="w">        </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/size&#39;</span>
<span class="w">      </span><span class="nt">size_function</span><span class="p">:</span>
<span class="w">        </span><span class="c1"># TODO: make this an enumeration</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<span class="w">        </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">exponential</span>
<span class="w">      </span><span class="nt">cloning_rate</span><span class="p">:</span>
<span class="w">        </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/rate&#39;</span>
<span class="w">      </span><span class="nt">selfing_rate</span><span class="p">:</span>
<span class="w">        </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/rate&#39;</span>

<span class="w">  </span><span class="nt">deme</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
<span class="w">    </span><span class="nt">additionalProperties</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">    </span><span class="nt">properties</span><span class="p">:</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span>
<span class="w">        </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/name&#39;</span>
<span class="w">      </span><span class="nt">description</span><span class="p">:</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;string&quot;</span>
<span class="w">        </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">      </span><span class="nt">ancestors</span><span class="p">:</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array</span>
<span class="w">        </span><span class="nt">items</span><span class="p">:</span>
<span class="w">          </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/name&#39;</span>
<span class="w">        </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="w">      </span><span class="nt">proportions</span><span class="p">:</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array</span>
<span class="w">        </span><span class="nt">items</span><span class="p">:</span>
<span class="w">          </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/proportion&#39;</span>
<span class="w">      </span><span class="nt">start_time</span><span class="p">:</span>
<span class="w">        </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/start_time&#39;</span>
<span class="w">      </span><span class="nt">epochs</span><span class="p">:</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array</span>
<span class="w">        </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="w">        </span><span class="nt">minItems</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="w">        </span><span class="nt">items</span><span class="p">:</span>
<span class="w">          </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/epoch&#39;</span>
<span class="w">      </span><span class="nt">defaults</span><span class="p">:</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
<span class="w">        </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="w">        </span><span class="nt">additionalProperties</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">        </span><span class="nt">properties</span><span class="p">:</span>
<span class="w">          </span><span class="nt">epoch</span><span class="p">:</span>
<span class="w">            </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/epoch&#39;</span>
<span class="w">    </span><span class="nt">required</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span>

<span class="w">  </span><span class="nt">pulse</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
<span class="w">    </span><span class="nt">additionalProperties</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">    </span><span class="nt">properties</span><span class="p">:</span>
<span class="w">      </span><span class="nt">sources</span><span class="p">:</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array</span>
<span class="w">        </span><span class="nt">items</span><span class="p">:</span>
<span class="w">          </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/name&#39;</span>
<span class="w">      </span><span class="nt">dest</span><span class="p">:</span>
<span class="w">        </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/name&#39;</span>
<span class="w">      </span><span class="nt">time</span><span class="p">:</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">number</span>
<span class="w">        </span><span class="nt">exclusiveMinimum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="w">      </span><span class="nt">proportions</span><span class="p">:</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array</span>
<span class="w">        </span><span class="nt">items</span><span class="p">:</span>
<span class="w">          </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/proportion&#39;</span>

<span class="w">  </span><span class="nt">migration</span><span class="p">:</span>
<span class="w">    </span><span class="nt">anyOf</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># Asymmetric</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
<span class="w">      </span><span class="nt">additionalProperties</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">      </span><span class="nt">properties</span><span class="p">:</span>
<span class="w">        </span><span class="nt">source</span><span class="p">:</span>
<span class="w">          </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/name&#39;</span>
<span class="w">        </span><span class="nt">dest</span><span class="p">:</span>
<span class="w">          </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/name&#39;</span>
<span class="w">        </span><span class="nt">start_time</span><span class="p">:</span>
<span class="w">          </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/start_time&#39;</span>
<span class="w">        </span><span class="nt">end_time</span><span class="p">:</span>
<span class="w">          </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/end_time&#39;</span>
<span class="w">        </span><span class="nt">rate</span><span class="p">:</span>
<span class="w">          </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/rate&#39;</span>
<span class="w">    </span><span class="c1"># Symmetric</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
<span class="w">      </span><span class="nt">additionalProperties</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">      </span><span class="nt">properties</span><span class="p">:</span>
<span class="w">        </span><span class="nt">demes</span><span class="p">:</span>
<span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array</span>
<span class="w">          </span><span class="nt">items</span><span class="p">:</span>
<span class="w">            </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/name&#39;</span>
<span class="w">          </span><span class="nt">minItems</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">        </span><span class="nt">start_time</span><span class="p">:</span>
<span class="w">          </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/start_time&#39;</span>
<span class="w">        </span><span class="nt">end_time</span><span class="p">:</span>
<span class="w">          </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/end_time&#39;</span>
<span class="w">        </span><span class="nt">rate</span><span class="p">:</span>
<span class="w">          </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/rate&#39;</span>
</pre></div>
</div>
</section>
</section>
<section id="reference-parser-implementation">
<span id="sec-spec-reference-implementation"></span><h2>Reference parser implementation<a class="headerlink" href="#reference-parser-implementation" title="Link to this heading">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># A simple parser that builds a fully-qualified Demes Graph from an input JSON</span>
<span class="c1"># string.</span>
<span class="c1">#</span>
<span class="c1"># Requires Python 3.7+.</span>
<span class="c1">#</span>
<span class="c1"># This implementation is NOT recommended for use in any downstream software and</span>
<span class="c1"># is provided purely as reference material for parser writers (i.e., in other</span>
<span class="c1"># programming languages). Python users should use the &quot;demes&quot; package in their</span>
<span class="c1"># software: https://github.com/popsim-consortium/demes-python</span>
<span class="c1">#</span>
<span class="c1"># The entry point is the ``parse`` function, which returns a fully-qualified</span>
<span class="c1"># Graph. The implementation is written with clarity and correctness as the main</span>
<span class="c1"># priorities. Its main purpose is to remove any potential ambiguities that may</span>
<span class="c1"># exist in the written specification and to simplify the process of writing</span>
<span class="c1"># other parsers. In the interest of simplicity, the parser does not generate</span>
<span class="c1"># useful error messages in all cases (but we would hope that practical</span>
<span class="c1"># implementations would).</span>
<span class="c1">#</span>
<span class="c1"># Type annotations are used where they help with readability, but not applied</span>
<span class="c1"># exhaustively.</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numbers</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">dataclasses</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1"># Numerical wiggle room.</span>
<span class="n">EPSILON</span> <span class="o">=</span> <span class="mf">1e-6</span>

<span class="c1"># JSON does not provide a way to encode IEEE infinity values, which we</span>
<span class="c1"># require to describe start_time values. To work around this we use the</span>
<span class="c1"># string &quot;Infinity&quot; to represent IEEE positive infinity.</span>
<span class="n">JSON_INFINITY_STR</span> <span class="o">=</span> <span class="s2">&quot;Infinity&quot;</span>


<span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Graph</span><span class="p">:</span>
    <span class="c1"># Parsing is done by popping items out of the input data dictionary and</span>
    <span class="c1"># creating the appropriate Python objects. We ensure that extra items</span>
    <span class="c1"># have not been included in the data payload by checking if the objects</span>
    <span class="c1"># are empty once we have removed all the values defined in the</span>
    <span class="c1"># specification. Type and range validation of simple items (e.g., the</span>
    <span class="c1"># value must be a positive integer) is performed at the same time,</span>
    <span class="c1"># using the pop_x functions. Once the full object model of the input</span>
    <span class="c1"># data has been built, the rules for creating a fully-qualified Demes</span>
    <span class="c1"># graph are applied in the &quot;resolve&quot; functions. Finally, we validate</span>
    <span class="c1"># the fully-qualified graph to ensure that relationships between the</span>
    <span class="c1"># entities have been specified correctly.</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="n">defaults</span> <span class="o">=</span> <span class="n">pop_object</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;defaults&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">deme_defaults</span> <span class="o">=</span> <span class="n">pop_object</span><span class="p">(</span><span class="n">defaults</span><span class="p">,</span> <span class="s2">&quot;deme&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">migration_defaults</span> <span class="o">=</span> <span class="n">pop_object</span><span class="p">(</span><span class="n">defaults</span><span class="p">,</span> <span class="s2">&quot;migration&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">pulse_defaults</span> <span class="o">=</span> <span class="n">pop_object</span><span class="p">(</span><span class="n">defaults</span><span class="p">,</span> <span class="s2">&quot;pulse&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="c1"># epoch defaults may also be specified within a Deme definition.</span>
    <span class="n">global_epoch_defaults</span> <span class="o">=</span> <span class="n">pop_object</span><span class="p">(</span><span class="n">defaults</span><span class="p">,</span> <span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">check_empty</span><span class="p">(</span><span class="n">defaults</span><span class="p">)</span>

    <span class="n">graph</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="n">pop_string</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="n">time_units</span><span class="o">=</span><span class="n">pop_string</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;time_units&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="n">doi</span><span class="o">=</span><span class="n">pop_list</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;doi&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="nb">str</span><span class="p">,</span> <span class="n">is_nonempty</span><span class="p">),</span>
        <span class="n">generation_time</span><span class="o">=</span><span class="n">pop_number</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span> <span class="s2">&quot;generation_time&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">is_positive_and_finite</span>
        <span class="p">),</span>
        <span class="n">metadata</span><span class="o">=</span><span class="n">pop_object</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="p">{}),</span>
    <span class="p">)</span>
    <span class="n">check_defaults</span><span class="p">(</span>
        <span class="n">deme_defaults</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span>
            <span class="n">description</span><span class="o">=</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">start_time</span><span class="o">=</span><span class="p">((</span><span class="nb">str</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">),</span> <span class="n">is_positive_or_json_infinity</span><span class="p">),</span>
            <span class="n">ancestors</span><span class="o">=</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">is_list_of_identifiers</span><span class="p">),</span>
            <span class="n">proportions</span><span class="o">=</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">is_list_of_fractions</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">allowed_epoch_defaults</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">end_time</span><span class="o">=</span><span class="p">(</span><span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">is_non_negative_and_finite</span><span class="p">),</span>
        <span class="n">start_size</span><span class="o">=</span><span class="p">(</span><span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">is_positive_and_finite</span><span class="p">),</span>
        <span class="n">end_size</span><span class="o">=</span><span class="p">(</span><span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">is_positive_and_finite</span><span class="p">),</span>
        <span class="n">selfing_rate</span><span class="o">=</span><span class="p">(</span><span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">is_fraction</span><span class="p">),</span>
        <span class="n">cloning_rate</span><span class="o">=</span><span class="p">(</span><span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">is_fraction</span><span class="p">),</span>
        <span class="n">size_function</span><span class="o">=</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">check_defaults</span><span class="p">(</span><span class="n">global_epoch_defaults</span><span class="p">,</span> <span class="n">allowed_epoch_defaults</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">deme_data</span> <span class="ow">in</span> <span class="n">pop_list</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;demes&quot;</span><span class="p">):</span>
        <span class="n">insert_defaults</span><span class="p">(</span><span class="n">deme_data</span><span class="p">,</span> <span class="n">deme_defaults</span><span class="p">)</span>
        <span class="n">deme</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">add_deme</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">pop_string</span><span class="p">(</span><span class="n">deme_data</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">validator</span><span class="o">=</span><span class="n">is_identifier</span><span class="p">),</span>
            <span class="n">description</span><span class="o">=</span><span class="n">pop_string</span><span class="p">(</span><span class="n">deme_data</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="n">start_time</span><span class="o">=</span><span class="n">pop_number</span><span class="p">(</span>
                <span class="n">deme_data</span><span class="p">,</span>
                <span class="s2">&quot;start_time&quot;</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="n">is_positive_or_json_infinity</span><span class="p">,</span>
                <span class="n">allow_inf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">ancestors</span><span class="o">=</span><span class="n">pop_list</span><span class="p">(</span><span class="n">deme_data</span><span class="p">,</span> <span class="s2">&quot;ancestors&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="nb">str</span><span class="p">,</span> <span class="n">is_identifier</span><span class="p">),</span>
            <span class="n">proportions</span><span class="o">=</span><span class="n">pop_list</span><span class="p">(</span>
                <span class="n">deme_data</span><span class="p">,</span> <span class="s2">&quot;proportions&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">is_fraction</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="n">local_defaults</span> <span class="o">=</span> <span class="n">pop_object</span><span class="p">(</span><span class="n">deme_data</span><span class="p">,</span> <span class="s2">&quot;defaults&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">local_epoch_defaults</span> <span class="o">=</span> <span class="n">pop_object</span><span class="p">(</span><span class="n">local_defaults</span><span class="p">,</span> <span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">check_empty</span><span class="p">(</span><span class="n">local_defaults</span><span class="p">)</span>
        <span class="n">check_defaults</span><span class="p">(</span><span class="n">local_epoch_defaults</span><span class="p">,</span> <span class="n">allowed_epoch_defaults</span><span class="p">)</span>
        <span class="n">epoch_defaults</span> <span class="o">=</span> <span class="n">global_epoch_defaults</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">epoch_defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">local_epoch_defaults</span><span class="p">)</span>
        <span class="n">check_defaults</span><span class="p">(</span><span class="n">epoch_defaults</span><span class="p">,</span> <span class="n">allowed_epoch_defaults</span><span class="p">)</span>

        <span class="c1"># There is always at least one epoch defined with the default values.</span>
        <span class="k">for</span> <span class="n">epoch_data</span> <span class="ow">in</span> <span class="n">pop_list</span><span class="p">(</span><span class="n">deme_data</span><span class="p">,</span> <span class="s2">&quot;epochs&quot;</span><span class="p">,</span> <span class="p">[{}]):</span>
            <span class="n">insert_defaults</span><span class="p">(</span><span class="n">epoch_data</span><span class="p">,</span> <span class="n">epoch_defaults</span><span class="p">)</span>
            <span class="n">deme</span><span class="o">.</span><span class="n">add_epoch</span><span class="p">(</span>
                <span class="n">end_time</span><span class="o">=</span><span class="n">pop_number</span><span class="p">(</span>
                    <span class="n">epoch_data</span><span class="p">,</span> <span class="s2">&quot;end_time&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">is_non_negative_and_finite</span>
                <span class="p">),</span>
                <span class="n">start_size</span><span class="o">=</span><span class="n">pop_number</span><span class="p">(</span>
                    <span class="n">epoch_data</span><span class="p">,</span> <span class="s2">&quot;start_size&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">is_positive_and_finite</span>
                <span class="p">),</span>
                <span class="n">end_size</span><span class="o">=</span><span class="n">pop_number</span><span class="p">(</span>
                    <span class="n">epoch_data</span><span class="p">,</span> <span class="s2">&quot;end_size&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">is_positive_and_finite</span>
                <span class="p">),</span>
                <span class="n">selfing_rate</span><span class="o">=</span><span class="n">pop_number</span><span class="p">(</span><span class="n">epoch_data</span><span class="p">,</span> <span class="s2">&quot;selfing_rate&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">is_fraction</span><span class="p">),</span>
                <span class="n">cloning_rate</span><span class="o">=</span><span class="n">pop_number</span><span class="p">(</span><span class="n">epoch_data</span><span class="p">,</span> <span class="s2">&quot;cloning_rate&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">is_fraction</span><span class="p">),</span>
                <span class="n">size_function</span><span class="o">=</span><span class="n">pop_string</span><span class="p">(</span><span class="n">epoch_data</span><span class="p">,</span> <span class="s2">&quot;size_function&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">check_empty</span><span class="p">(</span><span class="n">epoch_data</span><span class="p">)</span>
        <span class="n">check_empty</span><span class="p">(</span><span class="n">deme_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">deme</span><span class="o">.</span><span class="n">epochs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no epochs for deme </span><span class="si">{</span><span class="n">deme</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">demes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;the graph must have one or more demes&quot;</span><span class="p">)</span>

    <span class="n">check_defaults</span><span class="p">(</span>
        <span class="n">migration_defaults</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span>
            <span class="n">rate</span><span class="o">=</span><span class="p">(</span><span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">is_fraction</span><span class="p">),</span>
            <span class="n">start_time</span><span class="o">=</span><span class="p">((</span><span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="n">is_positive_or_json_infinity</span><span class="p">),</span>
            <span class="n">end_time</span><span class="o">=</span><span class="p">(</span><span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">is_non_negative_and_finite</span><span class="p">),</span>
            <span class="n">source</span><span class="o">=</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">is_identifier</span><span class="p">),</span>
            <span class="n">dest</span><span class="o">=</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">is_identifier</span><span class="p">),</span>
            <span class="n">demes</span><span class="o">=</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">is_list_of_identifiers</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">migration_data</span> <span class="ow">in</span> <span class="n">pop_list</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;migrations&quot;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="n">insert_defaults</span><span class="p">(</span><span class="n">migration_data</span><span class="p">,</span> <span class="n">migration_defaults</span><span class="p">)</span>
        <span class="n">graph</span><span class="o">.</span><span class="n">add_migration</span><span class="p">(</span>
            <span class="n">rate</span><span class="o">=</span><span class="n">pop_number</span><span class="p">(</span><span class="n">migration_data</span><span class="p">,</span> <span class="s2">&quot;rate&quot;</span><span class="p">,</span> <span class="n">validator</span><span class="o">=</span><span class="n">is_fraction</span><span class="p">),</span>
            <span class="n">start_time</span><span class="o">=</span><span class="n">pop_number</span><span class="p">(</span>
                <span class="n">migration_data</span><span class="p">,</span>
                <span class="s2">&quot;start_time&quot;</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="n">is_positive_or_json_infinity</span><span class="p">,</span>
                <span class="n">allow_inf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">end_time</span><span class="o">=</span><span class="n">pop_number</span><span class="p">(</span>
                <span class="n">migration_data</span><span class="p">,</span> <span class="s2">&quot;end_time&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">is_non_negative_and_finite</span>
            <span class="p">),</span>
            <span class="n">source</span><span class="o">=</span><span class="n">pop_string</span><span class="p">(</span><span class="n">migration_data</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">is_nonempty</span><span class="p">),</span>
            <span class="n">dest</span><span class="o">=</span><span class="n">pop_string</span><span class="p">(</span><span class="n">migration_data</span><span class="p">,</span> <span class="s2">&quot;dest&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">is_nonempty</span><span class="p">),</span>
            <span class="n">demes</span><span class="o">=</span><span class="n">pop_list</span><span class="p">(</span>
                <span class="n">migration_data</span><span class="p">,</span>
                <span class="s2">&quot;demes&quot;</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">required_type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">validator</span><span class="o">=</span><span class="n">is_identifier</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">check_empty</span><span class="p">(</span><span class="n">migration_data</span><span class="p">)</span>

    <span class="n">check_defaults</span><span class="p">(</span>
        <span class="n">pulse_defaults</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span>
            <span class="n">sources</span><span class="o">=</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">is_nonempty_list_of_identifiers</span><span class="p">),</span>
            <span class="n">dest</span><span class="o">=</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">is_identifier</span><span class="p">),</span>
            <span class="n">time</span><span class="o">=</span><span class="p">(</span><span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">is_positive_and_finite</span><span class="p">),</span>
            <span class="n">proportions</span><span class="o">=</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">is_nonempty_list_of_fractions_with_sum_less_than_1</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">pulse_data</span> <span class="ow">in</span> <span class="n">pop_list</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;pulses&quot;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="n">insert_defaults</span><span class="p">(</span><span class="n">pulse_data</span><span class="p">,</span> <span class="n">pulse_defaults</span><span class="p">)</span>
        <span class="n">graph</span><span class="o">.</span><span class="n">add_pulse</span><span class="p">(</span>
            <span class="n">sources</span><span class="o">=</span><span class="n">pop_list</span><span class="p">(</span>
                <span class="n">pulse_data</span><span class="p">,</span>
                <span class="s2">&quot;sources&quot;</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">required_type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">validator</span><span class="o">=</span><span class="n">is_identifier</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">dest</span><span class="o">=</span><span class="n">pop_string</span><span class="p">(</span><span class="n">pulse_data</span><span class="p">,</span> <span class="s2">&quot;dest&quot;</span><span class="p">,</span> <span class="n">validator</span><span class="o">=</span><span class="n">is_identifier</span><span class="p">),</span>
            <span class="n">time</span><span class="o">=</span><span class="n">pop_number</span><span class="p">(</span><span class="n">pulse_data</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">validator</span><span class="o">=</span><span class="n">is_positive_and_finite</span><span class="p">),</span>
            <span class="n">proportions</span><span class="o">=</span><span class="n">pop_list</span><span class="p">(</span>
                <span class="n">pulse_data</span><span class="p">,</span>
                <span class="s2">&quot;proportions&quot;</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">required_type</span><span class="o">=</span><span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span>
                <span class="n">validator</span><span class="o">=</span><span class="n">is_fraction</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">check_empty</span><span class="p">(</span><span class="n">pulse_data</span><span class="p">)</span>

    <span class="n">check_empty</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># The input object model has now been fully populated, and local type and</span>
    <span class="c1"># value checking done. Default values (either from the schema or set explicitly</span>
    <span class="c1"># by the user via &quot;defaults&quot; sections) have been assigned. We now &quot;resolve&quot;</span>
    <span class="c1"># the model so that any values that can be imputed from the structure of the</span>
    <span class="c1"># model are set explicitly. Once this is done, we then validate the model to</span>
    <span class="c1"># check that the relationships between various entities make sense. Note that</span>
    <span class="c1"># there isn&#39;t a clean separation between resolution and validation here, since</span>
    <span class="c1"># some validation is simplest to perform as part of the resolution logic in</span>
    <span class="c1"># this particular implementation.</span>
    <span class="n">graph</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
    <span class="n">graph</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">graph</span>


<span class="k">def</span> <span class="nf">encode_inf</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">JSON_INFINITY_STR</span>
    <span class="k">return</span> <span class="n">value</span>


<span class="c1"># Validator functions. These are used as arguments to the pop_x functions and</span>
<span class="c1"># check properties of the values.</span>


<span class="k">def</span> <span class="nf">is_positive_or_json_infinity</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">value</span> <span class="o">==</span> <span class="n">JSON_INFINITY_STR</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span>


<span class="k">def</span> <span class="nf">is_positive_and_finite</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_non_negative_and_finite</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_fraction</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">is_nonempty</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>


<span class="k">def</span> <span class="nf">is_identifier</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">isidentifier</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">is_list_of_identifiers</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_identifier</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_nonempty_list_of_identifiers</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">is_list_of_identifiers</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>


<span class="k">def</span> <span class="nf">is_list_of_fractions</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_fraction</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_nonempty_list_of_fractions_with_sum_less_than_1</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">is_list_of_fractions</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">sum</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">validate_item</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">required_type</span><span class="p">,</span> <span class="n">validator</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">required_type</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Attribute &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; must be a </span><span class="si">{</span><span class="n">required_type</span><span class="si">}</span><span class="s2">; &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;current type is </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">validator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">validator</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="n">validator_name</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="vm">__name__</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>  <span class="c1"># Strip off is_ from function name</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attribute &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; is not </span><span class="si">{</span><span class="n">validator_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="c1"># We need to use this trick because None is a meaningful input value for these</span>
<span class="c1"># pop_x functions.</span>
<span class="n">NO_DEFAULT</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">pop_item</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">required_type</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">NO_DEFAULT</span><span class="p">,</span> <span class="n">validator</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">validate_item</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">required_type</span><span class="p">,</span> <span class="n">validator</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="n">NO_DEFAULT</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attribute &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; is required&quot;</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">default</span>
    <span class="k">return</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">pop_list</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">NO_DEFAULT</span><span class="p">,</span> <span class="n">required_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validator</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">pop_item</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span> <span class="n">required_type</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">required_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">validate_item</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">required_type</span><span class="p">,</span> <span class="n">validator</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">pop_object</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">NO_DEFAULT</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pop_item</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span> <span class="n">required_type</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pop_string</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">NO_DEFAULT</span><span class="p">,</span> <span class="n">validator</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pop_item</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span> <span class="n">required_type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">validator</span><span class="o">=</span><span class="n">validator</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pop_number</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">NO_DEFAULT</span><span class="p">,</span> <span class="n">validator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_inf</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># If infinite values are allowed for this number, the string &quot;Infinity&quot;</span>
    <span class="c1"># is also accepted, and so str is an accepted type. There is a small loophole</span>
    <span class="c1"># here in which string numbers like &quot;1000&quot; will be accepted by the type</span>
    <span class="c1"># checking machinery, but the is_positive_or_json_infinity validator</span>
    <span class="c1"># will catch this and raise a TypeError when it tries to compare with 0.</span>
    <span class="k">if</span> <span class="n">allow_inf</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">validator</span> <span class="ow">is</span> <span class="n">is_positive_or_json_infinity</span>
    <span class="n">required_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">if</span> <span class="n">allow_inf</span> <span class="k">else</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">pop_item</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
        <span class="n">required_type</span><span class="o">=</span><span class="n">required_type</span><span class="p">,</span>
        <span class="n">validator</span><span class="o">=</span><span class="n">validator</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">JSON_INFINITY_STR</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">return</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">check_empty</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extra fields are not permitted:</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">check_defaults</span><span class="p">(</span><span class="n">defaults</span><span class="p">,</span> <span class="n">allowed_fields</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_fields</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Only fields </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">allowed_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2"> can be specified &quot;</span>
                <span class="s2">&quot;in the defaults&quot;</span>
            <span class="p">)</span>
        <span class="n">required_type</span><span class="p">,</span> <span class="n">validator</span> <span class="o">=</span> <span class="n">allowed_fields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">validate_item</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">required_type</span><span class="p">,</span> <span class="n">validator</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">insert_defaults</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">defaults</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>


<span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">Interval</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A half-open time interval (start_time, end_time].</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">start_time</span> <span class="o">&gt;</span> <span class="n">end_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">start_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">=</span> <span class="n">end_time</span>

    <span class="k">def</span> <span class="nf">intersects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;True if self and other intersect, False otherwise.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">&gt;=</span> <span class="n">other</span><span class="o">.</span><span class="n">start_time</span> <span class="ow">or</span> <span class="n">other</span><span class="o">.</span><span class="n">end_time</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_subinterval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;True if self is completely contained within other, False otherwise.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">&lt;=</span> <span class="n">other</span><span class="o">.</span><span class="n">start_time</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">&gt;=</span> <span class="n">other</span><span class="o">.</span><span class="n">end_time</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">&gt;</span> <span class="n">time</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span>


<span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">Epoch</span><span class="p">:</span>
    <span class="n">end_time</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">start_size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">end_size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">size_function</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">selfing_rate</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">cloning_rate</span><span class="p">:</span> <span class="nb">float</span>

    <span class="k">def</span> <span class="nf">as_json_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_size</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_size</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">size_function</span> <span class="o">=</span> <span class="s2">&quot;constant&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">size_function</span> <span class="o">=</span> <span class="s2">&quot;exponential&quot;</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_function</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="s2">&quot;exponential&quot;</span><span class="p">,</span> <span class="s2">&quot;linear&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unknown size_function &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">size_function</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_function</span> <span class="o">==</span> <span class="s2">&quot;constant&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_size</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_size</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;size_function is constant but &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;start_size (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">start_size</span><span class="si">}</span><span class="s2">) != end_size (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">end_size</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>


<span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">Deme</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">start_time</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">ancestors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Deme</span><span class="p">]</span>
    <span class="n">proportions</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">epochs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Epoch</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_epoch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">end_time</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n">start_size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n">end_size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n">selfing_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">cloning_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">size_function</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Epoch</span><span class="p">:</span>
        <span class="n">epoch</span> <span class="o">=</span> <span class="n">Epoch</span><span class="p">(</span>
            <span class="n">end_time</span><span class="o">=</span><span class="n">end_time</span><span class="p">,</span>
            <span class="n">start_size</span><span class="o">=</span><span class="n">start_size</span><span class="p">,</span>
            <span class="n">end_size</span><span class="o">=</span><span class="n">end_size</span><span class="p">,</span>
            <span class="n">selfing_rate</span><span class="o">=</span><span class="n">selfing_rate</span><span class="p">,</span>
            <span class="n">cloning_rate</span><span class="o">=</span><span class="n">cloning_rate</span><span class="p">,</span>
            <span class="n">size_function</span><span class="o">=</span><span class="n">size_function</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">epoch</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">end_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">end_time</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">time_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Interval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">as_json_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="n">encode_inf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">),</span>
            <span class="s2">&quot;epochs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">epoch</span><span class="o">.</span><span class="n">as_json_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">],</span>
            <span class="s2">&quot;proportions&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">proportions</span><span class="p">,</span>
            <span class="s2">&quot;ancestors&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">deme</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">deme</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ancestors</span><span class="p">],</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__resolve_times</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ancestors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ancestors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">epochs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">end_time</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ancestors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Must explicitly set Deme.start_time when &gt; 1 ancestor&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">default</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ancestors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;deme </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> has finite start_time, but no ancestors&quot;</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">ancestor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ancestors</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ancestor</span><span class="o">.</span><span class="n">time_interval</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Deme </span><span class="si">{</span><span class="n">ancestor</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">ancestor</span><span class="o">.</span><span class="n">time_interval</span><span class="si">}</span><span class="s2">) doesn&#39;t &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;exist at deme </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;s start_time (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>

        <span class="c1"># The last epoch has a default end_time of 0</span>
        <span class="n">last_epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">last_epoch</span><span class="o">.</span><span class="n">end_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">last_epoch</span><span class="o">.</span><span class="n">end_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">last_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">epoch</span><span class="o">.</span><span class="n">end_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Epoch end_time must be specified&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">epoch</span><span class="o">.</span><span class="n">end_time</span> <span class="o">&gt;=</span> <span class="n">last_time</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Epoch end_times must be in decreasing order.&quot;</span><span class="p">)</span>
            <span class="n">last_time</span> <span class="o">=</span> <span class="n">epoch</span><span class="o">.</span><span class="n">end_time</span>

    <span class="k">def</span> <span class="nf">__resolve_sizes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">first_epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># The first epoch must specify either start_size or end_size</span>
        <span class="k">if</span> <span class="n">first_epoch</span><span class="o">.</span><span class="n">start_size</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">first_epoch</span><span class="o">.</span><span class="n">end_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Must specify one or more of start_size and end_size &quot;</span>
                <span class="s2">&quot;for the initial epoch&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">first_epoch</span><span class="o">.</span><span class="n">start_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">first_epoch</span><span class="o">.</span><span class="n">start_size</span> <span class="o">=</span> <span class="n">first_epoch</span><span class="o">.</span><span class="n">end_size</span>
        <span class="k">if</span> <span class="n">first_epoch</span><span class="o">.</span><span class="n">end_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">first_epoch</span><span class="o">.</span><span class="n">end_size</span> <span class="o">=</span> <span class="n">first_epoch</span><span class="o">.</span><span class="n">start_size</span>
        <span class="n">last_epoch</span> <span class="o">=</span> <span class="n">first_epoch</span>
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="n">epoch</span><span class="o">.</span><span class="n">start_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">epoch</span><span class="o">.</span><span class="n">start_size</span> <span class="o">=</span> <span class="n">last_epoch</span><span class="o">.</span><span class="n">end_size</span>
            <span class="k">if</span> <span class="n">epoch</span><span class="o">.</span><span class="n">end_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">epoch</span><span class="o">.</span><span class="n">end_size</span> <span class="o">=</span> <span class="n">epoch</span><span class="o">.</span><span class="n">start_size</span>
            <span class="n">last_epoch</span> <span class="o">=</span> <span class="n">epoch</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">==</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">first_epoch</span><span class="o">.</span><span class="n">start_size</span> <span class="o">!=</span> <span class="n">first_epoch</span><span class="o">.</span><span class="n">end_size</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot have varying population size in an infinite time interval&quot;</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__resolve_proportions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proportions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ancestors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">proportions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ancestors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">proportions</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must specify proportions for &gt; 1 ancestor demes&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__resolve_times</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__resolve_sizes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__resolve_proportions</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">:</span>
            <span class="n">epoch</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proportions</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ancestors</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;proportions must be same length as ancestors&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ancestors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proportions</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Sum of proportions must be approximately 1&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">anc</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">anc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ancestors</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ancestors</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ancestors list contains duplicates&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">:</span>
            <span class="n">epoch</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>


<span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">Pulse</span><span class="p">:</span>
    <span class="n">sources</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Deme</span><span class="p">]</span>
    <span class="n">dest</span><span class="p">:</span> <span class="n">Deme</span>
    <span class="n">time</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">proportions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">as_json_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;sources&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">source</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">]</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;dest&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="o">.</span><span class="n">name</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sources_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">sources_names</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot have source deme equal to dest&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources_names</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Duplicate deme in sources&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must have one or more source demes&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proportions</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Sources and proportions must have same lengths&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">time_interval</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Deme </span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> does not exist at time </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="c1"># Time limits for the destination deme are different to the source deme,</span>
        <span class="c1"># because the destination deme is affected immediately after the time</span>
        <span class="c1"># of the pulse. Thus, a pulse can occur at the destination deme&#39;s</span>
        <span class="c1"># start_time, but not at the destination deme&#39;s end_time.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="o">.</span><span class="n">start_time</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="o">.</span><span class="n">end_time</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Deme </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> does not exist at time </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proportions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">EPSILON</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Pulse proportions into </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> at time </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;sum to more than 1&quot;</span>
            <span class="p">)</span>


<span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">Migration</span><span class="p">:</span>
    <span class="n">rate</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">start_time</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">end_time</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">source</span><span class="p">:</span> <span class="n">Deme</span>
    <span class="n">dest</span><span class="p">:</span> <span class="n">Deme</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">time_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Interval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">as_json_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;start_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">encode_inf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">name</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;dest&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="o">.</span><span class="n">name</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">end_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="o">.</span><span class="n">end_time</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;start_time must be &gt; end_time&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot migrate from a deme to itself&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">deme</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_interval</span><span class="o">.</span><span class="n">is_subinterval</span><span class="p">(</span><span class="n">deme</span><span class="o">.</span><span class="n">time_interval</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Migration time interval must be within the each deme&#39;s &quot;</span>
                    <span class="s2">&quot;time interval&quot;</span>
                <span class="p">)</span>


<span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">Graph</span><span class="p">:</span>
    <span class="n">time_units</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">generation_time</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">doi</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">demes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Deme</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">migrations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Migration</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">pulses</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Pulse</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_deme</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">start_time</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n">ancestors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">proportions</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Deme</span><span class="p">:</span>
        <span class="n">deme</span> <span class="o">=</span> <span class="n">Deme</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
            <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span>
            <span class="n">ancestors</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">demes</span><span class="p">[</span><span class="n">deme_name</span><span class="p">]</span> <span class="k">for</span> <span class="n">deme_name</span> <span class="ow">in</span> <span class="n">ancestors</span><span class="p">],</span>
            <span class="n">proportions</span><span class="o">=</span><span class="n">proportions</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">deme</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">demes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Duplicate deme name &#39;</span><span class="si">{</span><span class="n">deme</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">demes</span><span class="p">[</span><span class="n">deme</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">deme</span>
        <span class="k">return</span> <span class="n">deme</span>

    <span class="k">def</span> <span class="nf">add_migration</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">start_time</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n">end_time</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n">source</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n">dest</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n">demes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Migration</span><span class="p">]:</span>
        <span class="n">migrations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Migration</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="c1"># symmetric</span>
            <span class="p">(</span><span class="n">demes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dest</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1"># asymmetric</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">demes</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dest</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must specify either source and dest, or demes&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">dest</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">migrations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">Migration</span><span class="p">(</span>
                    <span class="n">rate</span><span class="o">=</span><span class="n">rate</span><span class="p">,</span>
                    <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span>
                    <span class="n">end_time</span><span class="o">=</span><span class="n">end_time</span><span class="p">,</span>
                    <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">demes</span><span class="p">[</span><span class="n">source</span><span class="p">],</span>
                    <span class="n">dest</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">demes</span><span class="p">[</span><span class="n">dest</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">demes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">demes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must specify two or more deme names&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">deme_a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">demes</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">deme_b</span> <span class="ow">in</span> <span class="n">demes</span><span class="p">[</span><span class="n">j</span><span class="p">:]:</span>
                    <span class="n">migration_ab</span> <span class="o">=</span> <span class="n">Migration</span><span class="p">(</span>
                        <span class="n">rate</span><span class="o">=</span><span class="n">rate</span><span class="p">,</span>
                        <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span>
                        <span class="n">end_time</span><span class="o">=</span><span class="n">end_time</span><span class="p">,</span>
                        <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">demes</span><span class="p">[</span><span class="n">deme_a</span><span class="p">],</span>
                        <span class="n">dest</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">demes</span><span class="p">[</span><span class="n">deme_b</span><span class="p">],</span>
                    <span class="p">)</span>
                    <span class="n">migration_ba</span> <span class="o">=</span> <span class="n">Migration</span><span class="p">(</span>
                        <span class="n">rate</span><span class="o">=</span><span class="n">rate</span><span class="p">,</span>
                        <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span>
                        <span class="n">end_time</span><span class="o">=</span><span class="n">end_time</span><span class="p">,</span>
                        <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">demes</span><span class="p">[</span><span class="n">deme_b</span><span class="p">],</span>
                        <span class="n">dest</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">demes</span><span class="p">[</span><span class="n">deme_a</span><span class="p">],</span>
                    <span class="p">)</span>
                    <span class="n">migrations</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">migration_ab</span><span class="p">,</span> <span class="n">migration_ba</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">migrations</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">migrations</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">migrations</span>

    <span class="k">def</span> <span class="nf">add_pulse</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">sources</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">dest</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">time</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">proportions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="n">pulse</span> <span class="o">=</span> <span class="n">Pulse</span><span class="p">(</span>
            <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">demes</span><span class="p">[</span><span class="n">source</span><span class="p">]</span> <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">],</span>
            <span class="n">dest</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">demes</span><span class="p">[</span><span class="n">dest</span><span class="p">],</span>
            <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span>
            <span class="n">proportions</span><span class="o">=</span><span class="n">proportions</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pulses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pulse</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pulse</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_json_dict</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">as_json_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;demes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">deme</span><span class="o">.</span><span class="n">as_json_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">deme</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">demes</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;migrations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">migration</span><span class="o">.</span><span class="n">as_json_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">migration</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">migrations</span><span class="p">]</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;pulses&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">pulse</span><span class="o">.</span><span class="n">as_json_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">pulse</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pulses</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generation_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_units</span> <span class="o">==</span> <span class="s2">&quot;generations&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">generation_time</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Must specify Graph.generation_time if time_units is not &quot;</span>
                    <span class="s2">&quot;&#39;generations&#39;&quot;</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_units</span> <span class="o">==</span> <span class="s2">&quot;generations&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">generation_time</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;If time_units are in generations, generation_time must be 1&quot;</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">deme</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">demes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">deme</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">pulse</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pulses</span><span class="p">:</span>
            <span class="n">pulse</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">migration</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">migrations</span><span class="p">:</span>
            <span class="n">migration</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

        <span class="c1"># Migrations involving the same source and dest can&#39;t overlap temporally.</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">migration_a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">migrations</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">migration_b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">migrations</span><span class="p">[</span><span class="n">j</span><span class="p">:]:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">migration_a</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="n">migration_b</span><span class="o">.</span><span class="n">source</span>
                    <span class="ow">and</span> <span class="n">migration_a</span><span class="o">.</span><span class="n">dest</span> <span class="o">==</span> <span class="n">migration_b</span><span class="o">.</span><span class="n">dest</span>
                    <span class="ow">and</span> <span class="n">migration_a</span><span class="o">.</span><span class="n">time_interval</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">migration_b</span><span class="o">.</span><span class="n">time_interval</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">start_time</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">migration_a</span><span class="o">.</span><span class="n">end_time</span><span class="p">,</span> <span class="n">migration_b</span><span class="o">.</span><span class="n">end_time</span><span class="p">)</span>
                    <span class="n">end_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">migration_a</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">migration_b</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Competing migration definitions for </span><span class="si">{</span><span class="n">migration_a</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;and </span><span class="si">{</span><span class="n">migration_a</span><span class="o">.</span><span class="n">dest</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> during time interval &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">start_time</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">end_time</span><span class="si">}</span><span class="s2">]&quot;</span>
                    <span class="p">)</span>

        <span class="c1"># The rate of migration entering a deme cannot be more than 1 in any</span>
        <span class="c1"># given interval of time.</span>
        <span class="n">time_boundaries</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">time_boundaries</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">migration</span><span class="o">.</span><span class="n">start_time</span> <span class="k">for</span> <span class="n">migration</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">migrations</span><span class="p">)</span>
        <span class="n">time_boundaries</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">migration</span><span class="o">.</span><span class="n">end_time</span> <span class="k">for</span> <span class="n">migration</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">migrations</span><span class="p">)</span>
        <span class="n">time_boundaries</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="n">end_times</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">time_boundaries</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">start_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span> <span class="o">+</span> <span class="n">end_times</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ingress_rates</span> <span class="o">=</span> <span class="p">{</span><span class="n">deme_name</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">end_times</span><span class="p">)</span> <span class="k">for</span> <span class="n">deme_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">demes</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">start_times</span><span class="p">,</span> <span class="n">end_times</span><span class="p">)):</span>
            <span class="n">current_interval</span> <span class="o">=</span> <span class="n">Interval</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">migration</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">migrations</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">current_interval</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">migration</span><span class="o">.</span><span class="n">time_interval</span><span class="p">):</span>
                    <span class="n">rate</span> <span class="o">=</span> <span class="n">ingress_rates</span><span class="p">[</span><span class="n">migration</span><span class="o">.</span><span class="n">dest</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">migration</span><span class="o">.</span><span class="n">rate</span>
                    <span class="k">if</span> <span class="n">rate</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">EPSILON</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Migration rates into </span><span class="si">{</span><span class="n">migration</span><span class="o">.</span><span class="n">dest</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> sum to &quot;</span>
                            <span class="s2">&quot;more than 1 during the time inverval &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">start_time</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">end_time</span><span class="si">}</span><span class="s2">]&quot;</span>
                        <span class="p">)</span>
                    <span class="n">ingress_rates</span><span class="p">[</span><span class="n">migration</span><span class="o">.</span><span class="n">dest</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate</span>

    <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># A deme&#39;s ancestors must be listed before it, so any deme we</span>
        <span class="c1"># visit must always be visited after its ancestors.</span>
        <span class="k">for</span> <span class="n">deme</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">demes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">deme</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">migration</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">migrations</span><span class="p">:</span>
            <span class="n">migration</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>

        <span class="c1"># Sort pulses from oldest to youngest.</span>
        <span class="c1"># In a discrete-time setting, non-integer pulse times that are distinct</span>
        <span class="c1"># could be rounded to the same time value. If the input file has the pulses</span>
        <span class="c1"># in time-ascending order, then the pulses would occur in the opposite order</span>
        <span class="c1"># compared to a continuous-time simulator. Sorting before the rounding</span>
        <span class="c1"># occurs avoids this ambiguity, so we explicitly require pulses to be</span>
        <span class="c1"># sorted as part of the parser.</span>
        <span class="c1"># Note that Python implements &quot;stable&quot; sorting, which maintains the order</span>
        <span class="c1"># of pulses that have the same time value to start with (as required by</span>
        <span class="c1"># the spec).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pulses</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">pulse</span><span class="p">:</span> <span class="n">pulse</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="appendix">
<span id="sec-appendix"></span><h2>Appendix<a class="headerlink" href="#appendix" title="Link to this heading">#</a></h2>
<section id="converting-backwards-time-to-forwards-time">
<span id="sec-appendix-backwards-to-forwards"></span><h3>Converting backwards time to forwards time<a class="headerlink" href="#converting-backwards-time-to-forwards-time" title="Link to this heading">#</a></h3>
<p>Times in Demes models use a backwards-time convention, where the value <code class="docutils literal notranslate"><span class="pre">0</span></code> represents
now and time values increase towards the past.
However, many simulators use the opposite convention, where time <code class="docutils literal notranslate"><span class="pre">0</span></code> represents
some time in the past and time values increase towards the present.</p>
<p>To convert times in a Demes model into a forward-time representation:</p>
<ul class="simple">
<li><p>Set <code class="docutils literal notranslate"><span class="pre">y</span></code> equal to the minimum epoch end time in the resolved graph.</p></li>
<li><p>Set <code class="docutils literal notranslate"><span class="pre">x</span></code> equal to the most ancient, finite, value out of epoch <code class="docutils literal notranslate"><span class="pre">start_time</span></code>,
epoch <code class="docutils literal notranslate"><span class="pre">end_time</span></code>, migration <code class="docutils literal notranslate"><span class="pre">start_time</span></code>, or pulse <code class="docutils literal notranslate"><span class="pre">time</span></code>.</p></li>
<li><p>The model duration is <code class="docutils literal notranslate"><span class="pre">d</span> <span class="pre">=</span> <span class="pre">x</span> <span class="pre">-</span> <span class="pre">y</span></code>;</p></li>
<li><p>Using the convention of starting a forward-in-time model at time zero (
representing the parental generation at the beginning of a model), the model
runs forward in time from <code class="docutils literal notranslate"><span class="pre">(0,</span> <span class="pre">d]</span></code>.</p></li>
<li><p>For explicit simulations involving a “burn in time”, the previous interval is shifted by that length.
The duration of the burn-in period is <code class="docutils literal notranslate"><span class="pre">(0,</span> <span class="pre">b]</span></code>
and the events in the Demes graph occur from <code class="docutils literal notranslate"><span class="pre">(b,</span> <span class="pre">b</span> <span class="pre">+</span> <span class="pre">d]</span></code>.</p></li>
<li><p>Given these definitions, <code class="docutils literal notranslate"><span class="pre">f</span> <span class="pre">=</span> <span class="pre">b</span> <span class="pre">+</span> <span class="pre">d</span> <span class="pre">-</span> <span class="pre">t</span></code>, where <code class="docutils literal notranslate"><span class="pre">t</span></code> is a backwards time in the Demes model and <code class="docutils literal notranslate"><span class="pre">f</span></code> is the forwards-time equivalent.</p></li>
</ul>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="gallery.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Gallery</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#note-to-readers">Note to Readers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conventions-and-terminology">Conventions and Terminology</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#infinity">Infinity</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#machine-data-model">Machine Data Model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#common-concepts">Common concepts</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#time">Time</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#population-sizes">Population sizes</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#metadata">Metadata</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mdm-documents">MDM documents</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#description">description</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#doi">doi</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">metadata</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#time-units">time_units</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#generation-time">generation_time</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#demes">demes</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#pulses">pulses</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#migrations">migrations</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#deme">Deme</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#name">name</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">description</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ancestors">ancestors</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#proportions">proportions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#start-time">start_time</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#epochs">epochs</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#epoch">Epoch</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#end-time">end_time</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#start-size">start_size</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#end-size">end_size</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#size-function">size_function</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cloning-rate">cloning_rate</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#selfing-rate">selfing_rate</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pulse">Pulse</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sources">sources</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dest">dest</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">time</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">proportions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-sequential-application-of-pulses">Example: sequential application of pulses</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#important-considerations">Important considerations</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#migration">Migration</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#source">source</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">dest</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">start_time</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">end_time</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#rate">rate</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#schema">Schema</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#human-data-model">Human Data Model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#defaults">Defaults</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#top-level-defaults">Top-level defaults</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#deme-defaults">Deme defaults</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#resolution">Resolution</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-time-units">time_units</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-generation-time">generation_time</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-metadata">metadata</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-description">description</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-doi">doi</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-defaults">defaults</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#deme-resolution">Deme resolution</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-deme-defaults">defaults</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-deme-description">description</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-deme-ancestors">ancestors</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-deme-proportions">proportions</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-deme-start-time">start_time</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#epoch-resolution">Epoch resolution</a><ul class="nav section-nav flex-column">
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-epoch-end-time">end_time</a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#start-size-end-size">start_size, end_size</a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-epoch-size-function">size_function</a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-epoch-selfing-rate">selfing_rate</a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-epoch-cloning-rate">cloning_rate</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#migration-resolution">Migration resolution</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-migration-rate">rate</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-migration-source">source</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-migration-dest">dest</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-migration-demes">demes</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#symmetric-migration">Symmetric migration</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-migration-start-time">start_time</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-migration-end-time">end_time</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#pulse-resolution">Pulse resolution</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-pulse-sources">sources</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-pulse-proportions">proportions</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-pulse-dest">dest</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-resolution-pulse-time">time</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#sort-pulses">Sort pulses</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#validation">Validation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id37">generation_time</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id38">demes</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#id39">epochs</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id40">migrations</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id41">pulses</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sec-spec-hdm-schema">Schema</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reference-parser-implementation">Reference parser implementation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#appendix">Appendix</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#converting-backwards-time-to-forwards-time">Converting backwards time to forwards time</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By PopSim Consortium
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  demes-spec 0.9
</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549"></script>
<script defer src="_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>